<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Group Tools â€” API Execute (Canvas)</title>
<style>
/* ------------------------------------------------ */
/* ğŸŒ™ Dark Theme v4 (Horizontal Flow Layout) */
/* ------------------------------------------------ */
:root{
  --bg: #071224;            /* Main Dark Background */
  --card: #0f1720;          /* Card Background */
  --accent: #1f6feb;        /* Main Accent (Deep Blue) */
  --accent-dark: #104191;   /* Darker Accent for Contrast/Hover */
  --accent-light: #5998ff;  /* Lighter Accent for Text/Highlight */
  --muted: #7fa3c7;         /* Muted Text */
  --text-primary: #e6eef8;  /* Light Text (High Contrast) */
  --ok: #2db85a;            /* Success (Green) */
  --err: #e04d4d;           /* Error (Red) */
  --block: #112033;         /* Palette Block Background */
  --block-contrast: #16324b;/* Workspace Block Background (Higher Contrast) */
  --border: rgba(255,255,255,0.05); /* Border/Divider */
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text-primary)}
header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);background:var(--card)}
h1{margin:0;font-size:18px;color:var(--accent-light)}
.sub{font-size:12px;color:var(--muted)}
/* å…¨ä½“ã‚³ãƒ³ãƒ†ãƒŠ: å·¦ã‚«ãƒ©ãƒ 300pxã€å³ã‚«ãƒ©ãƒ ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ã‚’åºƒã */
.container{max-width:1400px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:300px 1fr;gap:24px}
.card{background:var(--card);padding:16px;border-radius:12px;border:1px solid var(--border);box-shadow:0 6px 24px rgba(0,0,0,0.6)}
label{display:block;font-size:13px;color:var(--accent-light);font-weight:600;margin-top:12px}
input[type=text], input[type=password], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,0.03);color:var(--text-primary);box-sizing:border-box;transition:border-color 0.2s}
input:focus, textarea:focus, select:focus {outline:none;border-color:var(--accent);background:var(--block-contrast)}
textarea{min-height:84px;resize:vertical}
.row{display:flex;gap:8px;align-items:center}
button{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer;font-weight:600;transition:background 0.2s}
button:hover{background:var(--accent-dark)}
button.ghost{background:transparent;border:1px solid var(--muted);color:var(--muted)}
button.ghost:hover{background:var(--block-contrast);color:var(--accent-light);border-color:var(--accent)}
button.small{padding:6px 10px;font-size:13px}
.danger{background:var(--err)}
.danger:hover{background:#b82b2b}
.ok{background:var(--ok)}
.ok:hover{background:#238c46}
.muted{color:var(--muted);font-size:13px}
.list{max-height:200px;overflow:auto;margin-top:8px;border-radius:8px}
.item{padding:10px;border-bottom:1px solid rgba(255,255,255,0.05);background:var(--card);display:flex;justify-content:space-between;align-items:center;transition:background 0.2s}
.item:hover{background:rgba(255,255,255,0.04)}
.item:last-child{border-bottom:none}
.item strong{color:var(--accent-light)}
.small{font-size:12px;color:var(--muted)}
pre{background:#031324;padding:12px;border-radius:8px;color:#cfefff;overflow:auto;max-height:360px;white-space:pre-wrap;border:1px solid var(--border);font-size:12px}
footer{padding:16px;text-align:center;color:var(--muted);font-size:12px}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.palette{display:grid;grid-template-columns:1fr;gap:8px}
.block{background:var(--block);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);cursor:grab;color:var(--text-primary);font-weight:600;transition:background 0.2s}
.block:hover{background:rgba(255,255,255,0.08)}
/* ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®è¨­å®š */
#workspace{
    min-height: 320px;
    border: 2px dashed var(--muted);
    padding: 12px;
    border-radius: 8px;
    background: rgba(255,255,255,0.01);
    display: flex;
    gap: 10px;
    overflow: auto; /* ç¸¦æ¨ªã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’è¨±å¯ */
}
/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æ¨ªé•·ãƒ•ãƒ­ãƒ¼ã«ã™ã‚‹ */
#workspace:not(.vertical) { 
    flex-direction: row;
    flex-wrap: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    align-items: flex-start;
}
/* ç¸¦ç©ã¿åˆ‡ã‚Šæ›¿ãˆæ™‚ã®è¨­å®š */
#workspace.vertical {
    flex-direction: column;
    flex-wrap: nowrap;
    overflow-x: hidden;
    overflow-y: auto;
    align-items: stretch;
}
.wblock{background:var(--block-contrast);padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:grab;min-width:260px;border:1px solid var(--border);box-shadow:0 0 0 0 transparent;transition:box-shadow 0.1s, background 0.2s}
/* æ¨ªãƒ•ãƒ­ãƒ¼æ™‚ã®ãƒ–ãƒ­ãƒƒã‚¯å¹… */
#workspace:not(.vertical) .wblock{min-width:300px;flex-shrink:0}
/* ç¸¦ãƒ•ãƒ­ãƒ¼æ™‚ã®ãƒ–ãƒ­ãƒƒã‚¯å¹… */
#workspace.vertical .wblock{margin-bottom:8px;}
.wblock:hover{background:rgba(22, 50, 75, 0.8);}
.wblock .meta{font-size:13px;font-weight:700;color:var(--accent-light)}
.wblock .small{font-size:12px;color:var(--muted)}
.wblock .btns{display:flex;gap:4px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.rowcenter{display:flex;align-items:center;gap:8px}
.block-config{display:none;padding:12px;margin-top:10px;background:var(--block);border-radius:8px;border:2px solid var(--accent)}
.badge{background:var(--accent-dark);padding:4px 8px;border-radius:999px;color:white;font-size:12px;font-weight:600}
.pill{display:inline-block;padding:4px 8px;border-radius:8px;background:var(--block);font-size:13px;color:var(--text-primary);font-weight:600}
.seq-list{max-height:260px;overflow:auto}
.title{font-weight:700;color:var(--accent-light);margin-bottom:8px;font-size:15px}
.help{font-size:12px;color:var(--muted);margin-top:8px}
.img-preview{width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid var(--border)}
.notice{font-size:12px;color:#ffd7a8;font-weight:600;margin-top:4px}
/* Layout adjustment for Scratch view (3-column) */
#viewScratch > div {
    display: flex;
    gap: 20px;
    align-items: flex-start;
}
#viewScratch .col-left {
    width: 200px; /* ãƒ‘ãƒ¬ãƒƒãƒˆãƒ»ãƒœã‚¿ãƒ³é¡ */
    flex-shrink: 0;
}
#viewScratch .col-right {
    width: 320px; /* è¨­å®šãƒ»ãƒ­ã‚°é¡ */
    flex-shrink: 0;
}
#viewScratch .col-center {
    flex-grow: 1; /* ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ */
}

@media (max-width: 1200px){ 
  .container{ grid-template-columns:1fr; gap: 16px; } 
  #viewScratch > div { flex-direction: column; }
  #viewScratch .col-left, #viewScratch .col-right { width: 100%; }
  /* ãƒ¢ãƒã‚¤ãƒ«/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã‚µã‚¤ã‚ºã§ã¯ç¸¦ç©ã¿ã«æˆ»ã™ */
  #workspace:not(.vertical) { 
      flex-direction: column;
      flex-wrap: nowrap;
      overflow-x: hidden;
      overflow-y: auto;
      align-items: stretch;
  }
}
</style>
</head>
<body>
<header>
Â  <div>
Â  Â  <h1>.,/?(~^=Â  Group Tools â€” API ExecuteÂ  =^~)?\,. </h1>
Â  Â  <div class="sub">Tab2 = rawAPIï¼ˆAPIã‚’ç›´æ¥å©ãï¼‰</div>
Â  </div>
Â  <div class="small">by ã¾ã‚ã‚“ãã‚“(ry.pv)</div>
</header>

<div class="container">
Â  <div class="card">
Â  Â  <div class="title">Tokens</div>
Â  Â  <label>Label</label>
Â  Â  <input id="tokenLabel" type="text" placeholder="label" />
Â  Â  <label>Token</label>
Â  Â  <input id="tokenValue" type="password" placeholder="user token" />
Â  Â  <div class="controls">
Â  Â  Â  <button id="saveToken" class="small">ä¿å­˜</button>
Â  Â  Â  <button id="clearTokens" class="small danger">å…¨éƒ¨å‰Šé™¤</button>
Â  Â  </div>
Â  Â  <div class="muted" style="margin-top:12px">ä¿å­˜æ¸ˆãƒˆãƒ¼ã‚¯ãƒ³</div>
Â  Â  <div id="tokenList" class="list"></div>

Â  Â  <hr style="margin:16px 0;border:none;border-top:1px solid var(--border)">

Â  Â  <div class="title">Icon / Image</div>
Â  Â  <div class="muted">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨ã®ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆbase64ã¨ã—ã¦ä¿å­˜ï¼‰</div>
Â  Â  <label>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
Â  Â  <input id="iconFile" type="file" accept="image/*" />
Â  Â  <div class="row" style="margin-top:12px">
Â  Â  Â  <img id="iconPreview" class="img-preview" alt="" />
Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  <div class="small" id="iconInfo">No icon</div>
Â  Â  Â  Â  <div style="margin-top:8px" class="controls">
Â  Â  Â  Â  Â  <button id="removeIcon" class="small ghost">å‰Šé™¤</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <hr style="margin:16px 0;border:none;border-top:1px solid var(--border)">

Â  Â  <div class="title">Group Templates</div>
Â  Â  <label>è¨­å®š Label</label>
Â  Â  <input id="gLabel" type="text" placeholder="group-1" />
Â  Â  <label>Group åï¼ˆè¡¨ç¤ºåï¼‰</label>
Â  Â  <input id="gName" type="text" placeholder="groupname" />
Â  Â  <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
Â  Â  <input id="gUsers" type="text" placeholder="123,456,789" />
Â  Â  <label>ä½œæˆæ•°</label>
Â  Â  <input id="gCount" type="text" value="1" />
Â  Â  <div class="controls" style="margin-top:8px">
Â  Â  Â  <button id="saveGroup" class="small">ä¿å­˜</button>
Â  Â  Â  <button id="refreshGroups" class="small ghost">ä¸€è¦§æ›´æ–°</button>
Â  Â  </div>
Â  Â  <div id="groupList" class="list" style="margin-top:8px"></div>

Â  Â  <hr style="margin:16px 0;border:none;border-top:1px solid var(--border)">

Â  Â  <div class="title">Saved Sequences</div>
Â  Â  <div class="controls">
Â  Â  Â  <input id="seqName" type="text" placeholder="Sequence name" />
Â  Â  Â  <button id="saveSeq" class="small">ä¿å­˜</button>
Â  Â  </div>
Â  Â  <div id="seqList" class="seq-list list"></div>
Â  Â  <div class="help">Sequence ã¯ localStorage ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
Â  Â  <div style="margin-top:12px" class="controls">
Â  Â  Â  <button id="exportAll" class="small">å…¨è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
Â  Â  Â  <button id="importAll" class="small ghost">å…¨è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
Â  Â  </div>
Â  </div>

Â  <div class="card">
Â  Â  <div class="row" style="justify-content:space-between;align-items:center;">
Â  Â  Â  <div>
Â  Â  Â  Â  <button id="tabExec" class="small ok">Execute</button>
Â  Â  Â  Â  <button id="tabScratch" class="small ghost">rawAPI</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="rowcenter">
Â  Â  Â  Â  <span class="pill">Select token:</span>
Â  Â  Â  Â  <select id="selectToken"><option value="">--é¸æŠ--</option></select>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="viewExec" style="margin-top:16px;">
Â  Â  Â  <div class="grid2">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="title">Quick Create from Template</div>
Â  Â  Â  Â  Â  <label>ãƒ†ãƒ³ãƒ—ãƒ¬ Label ã‚’é¸æŠ</label>
Â  Â  Â  Â  Â  <select id="tplSelect"><option value="">--é¸æŠ--</option></select>
Â  Â  Â  Â  Â  <div class="controls" style="margin-top:8px">
Â  Â  Â  Â  Â  Â  <button id="applyTpl" class="small">åˆ©ç”¨</button>
Â  Â  Â  Â  Â  Â  <button id="openScratch" class="small ghost">Open rawAPI</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-top:8px">ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ã€Œåˆ©ç”¨ã€ã‚’æŠ¼ã™ã¨ä¸‹ã®å®Ÿè¡Œãƒ•ã‚©ãƒ¼ãƒ ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="title">Execution Controls</div>
Â  Â  Â  Â  Â  <label><input type="checkbox" id="consentExec" /> å®Ÿè¡Œãƒªã‚¹ã‚¯ã‚’ç†è§£ã—ã¾ã—ãŸ</label>
Â  Â  Â  Â  Â  <div class="controls" style="margin-top:8px">
Â  Â  Â  Â  Â  Â  <button id="btnExec" class="ok small">å®Ÿè¡Œ (Execute)</button>
Â  Â  Â  Â  Â  Â  <button id="btnStop" class="danger small" style="display:none">åœæ­¢</button>
Â  Â  Â  Â  Â  Â  <button id="btnGen" class="ghost small">curl/fetch ç”Ÿæˆ</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <hr style="margin:16px 0;border:none;border-top:1px solid var(--border)">

Â  Â  Â  <div>
Â  Â  Â  Â  <div class="title">Create Parameters</div>
Â  Â  Â  Â  <label>Recipients (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
Â  Â  Â  Â  <input id="exec_recipients" type="text" />
Â  Â  Â  Â  <label>Optional name</label>
Â  Â  Â  Â  <input id="exec_name" type="text" />
Â  Â  Â  Â  <label>Count</label>
Â  Â  Â  Â  <input id="exec_count" type="text" value="1" />
Â  Â  Â  </div>

Â  Â  Â  <div style="margin-top:16px">
Â  Â  Â  Â  <div class="title">Log / Response</div>
Â  Â  Â  Â  <pre id="execLog">â€”</pre>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="viewScratch" style="margin-top:16px; display:none;">
Â  Â  Â  <div class="title">Workspace</div>
Â  Â  Â  <div>
Â  Â  Â  Â  <div class="col-left">
Â  Â  Â  Â  Â  <div class="title">Palette</div>
Â  Â  Â  Â  Â  <div class="muted">ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚° or ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ </div>
Â  Â  Â  Â  Â  <div class="palette" id="palette" style="margin-top:8px">
Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="api">API Call</div>
Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="wait">Wait (Delay)</div>
Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="loop">Loop (Next Block)</div>
Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="cond">If Condition</div>
Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="comment">Comment / Note</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="controls" style="margin-top:12px">
Â  Â  Â  Â  Â  Â  <button id="runSeq" class="ok small">å®Ÿè¡Œ</button>
Â  Â  Â  Â  Â  Â  <button id="clearWorkspace" class="ghost small">ã‚¯ãƒªã‚¢</button>
Â  Â  Â  Â  Â  Â  <button id="exportSeq" class="small">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
Â  Â  Â  Â  Â  Â  <button id="importSeq" class="small ghost">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  Â  Â  <button id="toggleLayout" class="small ghost">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡æ›¿ (ç¸¦/æ¨ª)</button>
Â  Â  Â  Â  Â  Â  <div class="notice" id="layoutNotice">ç¾åœ¨ï¼šæ¨ªè¡¨ç¤º</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="col-center">
Â  Â  Â  Â  Â  <div id="workspace" ondragover="event.preventDefault()"></div>
Â  Â  Â  Â  Â  <div class="title" style="margin-top:16px">Sequence Preview (JSON)</div>
Â  Â  Â  Â  Â  <pre id="seqPreview">[]</pre>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="col-right">
Â  Â  Â  Â  Â  <div class="title">Selected Block</div>
Â  Â  Â  Â  Â  <div id="blockConfig" class="block-config">é¸æŠã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç·¨é›†ã§ãã¾ã™</div>
Â  Â  Â  Â  Â  <div class="title" style="margin-top:16px">Current Variables (Context)</div>
Â  Â  Â  Â  Â  <pre id="contextView" style="max-height:100px;">{}</pre>
Â  Â  Â  Â  Â  <div class="title" style="margin-top:16px">rawAPI Log</div>
Â  Â  Â  Â  Â  <pre id="scratchLog">â€”</pre>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<footer>Local only â€” tokens, templates & sequences saved to localStorage</footer>

<script>
const STORAGE_KEY = 'selfhub_rawapi_v1';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {tokens:{}, templates:{}, sequences:{}, icon:null}; }catch(e){ return {tokens:{}, templates:{}, sequences:{}, icon:null}; }}
function saveDB(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); }catch(e){} refreshTokenUI(); refreshTplUI(); refreshSeqList(); }
let DB = loadDB();
const $ = id => document.getElementById(id);
function logLineExec(s){ const el = $('execLog'); el.textContent = (el.textContent === 'â€”' ? '' : el.textContent) + '['+new Date().toLocaleTimeString()+'] ' + s + '\n'; el.scrollTop = el.scrollHeight; }
function logLineScratch(s){ const el = $('scratchLog'); el.textContent = (el.textContent === 'â€”' ? '' : el.textContent) + '['+new Date().toLocaleTimeString()+'] ' + s + '\n'; el.scrollTop = el.scrollHeight; }
function appendLog(s){ logLineExec(s); if($('viewScratch').style.display !== 'none') logLineScratch(s); }
$('iconFile').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ DB.icon = r.result; saveDB(); $('iconPreview').src = DB.icon; $('iconInfo').textContent = 'Icon loaded'; appendLog('Icon saved'); }; r.readAsDataURL(f); });
$('removeIcon').onclick = ()=>{ DB.icon = null; saveDB(); $('iconPreview').src=''; $('iconInfo').textContent='No icon'; };
function refreshTokenUI(){ const list = $('tokenList'); list.innerHTML=''; const sel = $('selectToken'); sel.innerHTML='<option value="">--é¸æŠ--</option>'; Object.entries(DB.tokens||{}).forEach(([id,t])=>{ const div = document.createElement('div'); div.className='item'; div.innerHTML = `<div><strong>${escapeHtml(t.label||id)}</strong><div class="small">â€¢â€¢â€¢â€¢${t.token?t.token.slice(-6):'(empty)'}</div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useBtn small">é¸æŠ</button><button data-id="${id}" class="delBtn small danger">å‰Šé™¤</button></div>`; list.appendChild(div); const opt = document.createElement('option'); opt.value = id; opt.textContent = t.label||id; sel.appendChild(opt); }); Array.from(document.getElementsByClassName('useBtn')).forEach(b=> b.onclick = ()=> $('selectToken').value = b.dataset.id ); Array.from(document.getElementsByClassName('delBtn')).forEach(b=> b.onclick = ()=> { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.tokens[b.dataset.id]; saveDB(); refreshTokenUI(); } }); }
$('saveToken').onclick = ()=>{ const lbl = $('tokenLabel').value.trim(); const tok = $('tokenValue').value.trim(); if(!lbl||!tok){ alert('label ã¨ token ã‚’å…¥åŠ›'); return; } const id = 't_'+Date.now(); DB.tokens = DB.tokens || {}; DB.tokens[id] = {label:lbl, token:tok}; saveDB(); refreshTokenUI(); $('tokenLabel').value=''; $('tokenValue').value=''; };
$('clearTokens').onclick = ()=>{ if(confirm('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ DB.tokens={}; saveDB(); refreshTokenUI(); } };
function refreshTplUI(){ const out = $('groupList'); out.innerHTML=''; const sel = $('tplSelect'); sel.innerHTML = '<option value="">--é¸æŠ--</option>'; Object.entries(DB.templates||{}).forEach(([id,t])=>{ const div = document.createElement('div'); div.className='item'; div.innerHTML = `<div style="display:flex;gap:8px;align-items:center">${t.icon? `<img src="${t.icon}" class="img-preview" />` : `<div class="img-preview" style="background:var(--block);display:flex;align-items:center;justify-content:center;color:var(--muted)">no</div>`}<div><strong>${escapeHtml(t.label||id)}</strong><div class="small">${escapeHtml(t.name||'')} â†’ ${escapeHtml((t.users||[]).join(','))}</div></div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useTpl small">åˆ©ç”¨</button><button data-id="${id}" class="fillTpl small ghost">Fill</button><button data-id="${id}" class="delTpl small danger">å‰Šé™¤</button></div>`; out.appendChild(div); const opt = document.createElement('option'); opt.value = id; opt.textContent = t.label; sel.appendChild(opt); }); Array.from(document.getElementsByClassName('useTpl')).forEach(b=> b.onclick = ()=> applyTemplateToExec(b.dataset.id) ); Array.from(document.getElementsByClassName('fillTpl')).forEach(b=> b.onclick = ()=> fillTplForm(b.dataset.id) ); Array.from(document.getElementsByClassName('delTpl')).forEach(b=> b.onclick = ()=> { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.templates[b.dataset.id]; saveDB(); refreshTplUI(); } }); }
$('saveGroup').onclick = ()=>{ const lbl = $('gLabel').value.trim(); const name = $('gName').value.trim(); const users = $('gUsers').value.split(',').map(s=>s.trim()).filter(Boolean); const count = parseInt($('gCount').value)||1; if(!lbl||users.length<2){ alert('Label ã¨ user ã‚’(2äººä»¥ä¸Š)å…¥åŠ›'); return; } const id = 'tpl_'+Date.now(); DB.templates = DB.templates || {}; DB.templates[id] = {label:lbl, name:name, users:users, count:count, icon: DB.icon || null}; saveDB(); refreshTplUI(); $('gLabel').value=''; $('gName').value=''; $('gUsers').value=''; $('gCount').value='1'; };
$('refreshGroups').onclick = refreshTplUI;
$('applyTpl').onclick = ()=> applyTemplateToExec($('tplSelect').value);
function applyTemplateToExec(id){ const t = DB.templates[id]; if(!t) return; $('exec_recipients').value = (t.users||[]).join(','); $('exec_name').value = t.name||''; $('exec_count').value = t.count||1; if(t.icon){ DB.icon = t.icon; saveDB(); $('iconPreview').src = DB.icon; $('iconInfo').textContent='Icon loaded'; } alert('ãƒ†ãƒ³ãƒ—ãƒ¬é©ç”¨ã•ã‚Œã¾ã—ãŸ'); }
function fillTplForm(id){ const t = DB.templates[id]; if(!t) return; $('gLabel').value = t.label||''; $('gName').value = t.name||''; $('gUsers').value = (t.users||[]).join(','); $('gCount').value = t.count||1; }
function refreshSeqList(){ const out = $('seqList'); out.innerHTML=''; Object.entries(DB.sequences||{}).forEach(([id,s])=>{ const div = document.createElement('div'); div.className='item'; div.innerHTML = `<div><strong>${escapeHtml(s.name||id)}</strong><div class="small">${(s.blocks||[]).length} blocks</div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useSeq small">èª­ã¿è¾¼ã¿</button><button data-id="${id}" class="runSeqNow small ghost">å®Ÿè¡Œ</button><button data-id="${id}" class="delSeq small danger">å‰Šé™¤</button></div>`; out.appendChild(div); }); Array.from(document.getElementsByClassName('useSeq')).forEach(b=> b.onclick = ()=> loadSequenceIntoWorkspace(b.dataset.id) ); Array.from(document.getElementsByClassName('runSeqNow')).forEach(b=> b.onclick = ()=> { loadSequenceIntoWorkspace(b.dataset.id); setTimeout(()=> $('runSeq').click(), 120); } ); Array.from(document.getElementsByClassName('delSeq')).forEach(b=> b.onclick = ()=> { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.sequences[b.dataset.id]; saveDB(); refreshSeqList(); } }); }
$('saveSeq').onclick = ()=>{ const name = $('seqName').value.trim(); if(!name){ alert('Sequence name ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; } const data = workspaceToSequence(); if(data.length === 0){ alert('ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“'); return; } const id = 'seq_'+Date.now(); DB.sequences = DB.sequences || {}; DB.sequences[id] = {name:name, blocks:data}; saveDB(); refreshSeqList(); $('seqName').value=''; alert('ä¿å­˜ã—ã¾ã—ãŸ'); };
const workspace = $('workspace');
let blockCounter = 0;
function defaultBlockForType(type){ if(type==='api') return {type:'api', props:{method:'GET', path:'/users/@me', body:null, headers:{}, extract:null}}; if(type==='wait') return {type:'wait', props:{sec:1}}; if(type==='loop') return {type:'loop', props:{count:2, blocks:[]}}; if(type==='cond') return {type:'cond', props:{code:200, blocks:[], variable:'status', value:200}}; if(type==='comment') return {type:'comment', props:{text:'note'}}; return {type:type, props:{}}; }
function summaryForBlock(obj){ if(!obj) return ''; if(obj.type==='api') return `${obj.props.method||'GET'} ${obj.props.path||'/users/@me'}${obj.props.extract ? ` (extract: ${obj.props.extract.var})` : ''}`; if(obj.type==='wait') return `wait ${obj.props.sec||1}s`; if(obj.type==='loop') return `loop ${obj.props.count||1}x`; if(obj.type==='cond'){ if(obj.props.variable === 'status') return `if status == ${obj.props.value || obj.props.code||200}`; return `if {{${obj.props.variable}}} == ${obj.props.value !== undefined ? obj.props.value : ''}`; } if(obj.type==='comment') return obj.props.text||''; return ''; }
function makeWBlock(obj){ const id = 'b_'+(++blockCounter); obj._id = id; const el = document.createElement('div'); el.className='wblock'; el.draggable = true; el.dataset.id = id; el.innerHTML = `<div><div class="meta">${escapeHtml(obj.type.toUpperCase())}${obj.type==='api'? ' - '+escapeHtml(obj.props.method||'GET')+' '+escapeHtml(obj.props.path||'/users/@me'):''}</div><div class="small">${escapeHtml(summaryForBlock(obj))}</div></div><div class="btns"><button class="small ghost editBtn">âœ</button><button class="small ghost upBtn">â–²</button><button class="small ghost downBtn">â–¼</button><button class="small danger delBtn">âœ–</button></div>`; el._data = obj; el.addEventListener('dragstart', (e)=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', 'workspace:'+id); }); el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); }); el.addEventListener('click', (e)=> { e.stopPropagation(); selectBlock(el); } ); el.querySelector('.editBtn').onclick = (ev)=>{ ev.stopPropagation(); openBlockConfig(el); }; el.querySelector('.delBtn').onclick = (ev)=>{ ev.stopPropagation(); if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ el.remove(); refreshSeqPreview(); } }; el.querySelector('.upBtn').onclick = (ev)=>{ ev.stopPropagation(); const p = el.previousElementSibling; if(p) el.parentNode.insertBefore(el, p); refreshSeqPreview(); }; el.querySelector('.downBtn').onclick = (ev)=>{ ev.stopPropagation(); const n = el.nextElementSibling; if(n) el.parentNode.insertBefore(n, el); refreshSeqPreview(); }; return el; }
Array.from(document.getElementsByClassName('block')).forEach((b, idx)=>{ const t = b.dataset.type || ['api','wait','loop','cond','comment'][idx]; b.dataset.type = t; b.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', 'palette:'+t); b.classList.add('dragging'); }); b.addEventListener('dragend', ()=> b.classList.remove('dragging')); b.addEventListener('dblclick', ()=> { const el = makeWBlock(defaultBlockForType(t)); workspace.appendChild(el); refreshSeqPreview(); openBlockConfig(el); }); });
workspace.addEventListener('drop', (e)=>{ e.preventDefault(); const d = e.dataTransfer.getData('text/plain'); const afterElement = getDragAfterElement(workspace, e.clientX, e.clientY); if(!d) return; if(d.startsWith('palette:')){ const type = d.split(':')[1]; const obj = defaultBlockForType(type); const w = makeWBlock(obj); if(afterElement) workspace.insertBefore(w, afterElement); else workspace.appendChild(w); openBlockConfig(w); refreshSeqPreview(); } else if(d.startsWith('workspace:')){ const id = d.split(':')[1]; const draggedElement = document.querySelector(`.wblock[data-id="${id}"]`); if(draggedElement){ if(afterElement) workspace.insertBefore(draggedElement, afterElement); else workspace.appendChild(draggedElement); } refreshSeqPreview(); } });
workspace.addEventListener('dragover', e=> e.preventDefault());
function getDragAfterElement(container, x, y){ 
    const isVertical = container.classList.contains('vertical');
    const draggableElements = [...container.querySelectorAll('.wblock:not(.dragging)')]; 
    
    return draggableElements.reduce((closest, child)=>{ 
        const rect = child.getBoundingClientRect(); 
        const offset = isVertical ? y - rect.top - child.offsetHeight/2 : x - rect.left - child.offsetWidth/2; 
        
        if(offset < 0 && offset > closest.offset){ 
            return {offset:offset, element:child}; 
        }else{ 
            return closest; 
        } 
    }, {offset: -Infinity}).element; 
}
function selectBlock(el){ Array.from(workspace.children).forEach(c=> c.style.boxShadow='none'); el.style.boxShadow = '0 0 0 2px var(--accent-light)'; openBlockConfig(el); }
function openBlockConfig(el){ const cfg = $('blockConfig'); cfg.style.display = 'block'; cfg.innerHTML = ''; const obj = el._data; if(obj.type==='api'){ cfg.innerHTML = `<label>Method (GET/POST/..)</label><input id="cfg_method" type="text" value="${escapeHtml(obj.props.method||'GET')}" /><label>Path ({{var}} ã‚’åˆ©ç”¨å¯)</label><input id="cfg_path" type="text" value="${escapeHtml(obj.props.path||'/users/@me')}" /><label>Body (JSON, {{var}} ã‚’åˆ©ç”¨å¯)</label><textarea id="cfg_body" style="min-height:60px">${obj.props.body?escapeHtml(JSON.stringify(obj.props.body,null,2)):''}</textarea><label>Headers (JSON)</label><textarea id="cfg_headers" style="min-height:60px">${obj.props.headers?escapeHtml(JSON.stringify(obj.props.headers,null,2)):''}</textarea><div class="title" style="margin-top:10px">Extract Value</div><label>Save to variable (ä¾‹: channel_id)</label><input id="cfg_extract_var" type="text" value="${escapeHtml(obj.props.extract?.var||'')}" placeholder="å¤‰æ•°å" /><label>JSONPath (ä¾‹: .id, .messages[0].id)</label><input id="cfg_extract_path" type="text" value="${escapeHtml(obj.props.extract?.path||'')}" placeholder=".id" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; } else if(obj.type==='wait'){ cfg.innerHTML = `<label>Seconds</label><input id="cfg_sec" type="text" value="${escapeHtml(String(obj.props.sec||1))}" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; } else if(obj.type==='loop'){ cfg.innerHTML = `<label>Count</label><input id="cfg_count" type="text" value="${escapeHtml(String(obj.props.count||1))}" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; } else if(obj.type==='cond'){ cfg.innerHTML = `<label>Condition Target</label><select id="cfg_target"><option value="status" ${obj.props.variable === 'status' ? 'selected' : ''}>Status Code (ç›´å‰ã®API)</option><option value="variable" ${obj.props.variable !== 'status' ? 'selected' : ''}>Variable ({{var}})</option></select><div id="cfg_var_wrap" style="display:${obj.props.variable !== 'status' ? 'block' : 'none'}"><label>Variable Name ({{var}})</label><input id="cfg_variable" type="text" value="${escapeHtml(obj.props.variable !== 'status' ? (obj.props.variable || '') : '')}" /></div><label>Operator: == </label><label>Value</label><input id="cfg_value" type="text" value="${escapeHtml(String(obj.props.value !== undefined ? obj.props.value : (obj.props.code || 200)))}" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; $('cfg_target').onchange = (e)=>{ if(e.target.value === 'variable') $('cfg_var_wrap').style.display = 'block'; else $('cfg_var_wrap').style.display = 'none'; }; } else if(obj.type==='comment'){ cfg.innerHTML = `<label>Text</label><textarea id="cfg_text">${escapeHtml(obj.props.text||'')}</textarea><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; } $('cfgSave').onclick = ()=>{ try{ if(obj.type==='api'){ const btxt = $('cfg_body').value.trim(); obj.props.body = btxt? JSON.parse(btxt) : null; const htxt = $('cfg_headers').value.trim(); obj.props.headers = htxt? JSON.parse(htxt) : {}; obj.props.method = $('cfg_method').value.trim().toUpperCase()||'GET'; obj.props.path = $('cfg_path').value.trim()||'/users/@me'; const ext_var = $('cfg_extract_var').value.trim(); const ext_path = $('cfg_extract_path').value.trim(); if(ext_var && ext_path) obj.props.extract = {var:ext_var, path:ext_path}; else obj.props.extract = null; } else if(obj.type==='wait'){ obj.props.sec = Number($('cfg_sec').value)||1; } else if(obj.type==='loop'){ obj.props.count = Number($('cfg_count').value)||1; } else if(obj.type==='cond'){ const target = $('cfg_target').value; obj.props.variable = target === 'status' ? 'status' : $('cfg_variable').value.trim(); if(target === 'status') obj.props.code = Number($('cfg_value').value) || 200; else { obj.props.code = undefined; obj.props.value = $('cfg_value').value; } } else if(obj.type==='comment'){ obj.props.text = $('cfg_text').value||''; } }catch(e){ alert('JSON parse error'); return; } el.querySelector('.meta').textContent = obj.type.toUpperCase() + (obj.type==='api'? ' - '+obj.props.method+' '+obj.props.path : ''); el.querySelector('.small').textContent = summaryForBlock(obj); refreshSeqPreview(); cfg.style.display = 'none'; }; }
function workspaceToSequence(){ return Array.from(workspace.children).map(c=> c._data ? JSON.parse(JSON.stringify(c._data)) : null).filter(Boolean); }
function loadSequenceObjectToWorkspace(blocks){ workspace.innerHTML=''; blockCounter=0; if(!Array.isArray(blocks)) return; for(const b of blocks){ const el = makeWBlock(b); workspace.appendChild(el); } refreshSeqPreview(); }
function loadSequenceIntoWorkspace(id){ const s = DB.sequences[id]; if(!s){ alert('sequence not found'); return; } loadSequenceObjectToWorkspace(s.blocks||[]); }
function refreshSeqPreview(){ $('seqPreview').textContent = JSON.stringify(workspaceToSequence(), null, 2); }
$('clearWorkspace').onclick = ()=>{ if(confirm('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')){ loadSequenceObjectToWorkspace([]); } };
let runStopFlag = false;
$('btnStop').onclick = ()=>{ runStopFlag = true; $('btnStop').style.display='none'; appendLog('åœæ­¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã¾ã—ãŸ'); };
function sleepMs(ms){ return new Promise(r=>setTimeout(r, ms)); }
async function fetchWithRetry(url, opts){ while(true){ if(runStopFlag) throw new Error('Stopped by user'); const res = await fetch(url, opts); if(res.status !== 429) return res; let retry = 1; try{ const j = await res.json().catch(()=>null); retry = j && j.retry_after ? j.retry_after : (parseFloat(res.headers.get('Retry-After')) || 1); }catch(e){} appendLog(`429 ãƒ¬ãƒ¼ãƒˆåˆ¶é™: ${retry}s å¾…æ©Ÿ`); let left = Math.ceil(retry); while(left>0){ if(runStopFlag) throw new Error('Stopped by user'); await sleepMs(1000); left--; } } }
window._scratch_context = {};
function refreshContextView() { $('contextView').textContent = JSON.stringify(window._scratch_context, null, 2); }
function injectVariables(s, context) {
Â  Â  if (!s) return s;
Â  Â  return String(s).replace(/\{\{(\w+)\}\}/g, (match, p1) => context[p1] !== undefined ? context[p1] : match);
}
function extractValue(json, path) {
Â  Â  if (!json || !path) return undefined;
Â  Â  try {
Â  Â  Â  Â  if (path.startsWith('.')) path = path.slice(1);
Â  Â  Â  Â  const parts = path.split('.');
Â  Â  Â  Â  let current = json;
Â  Â  Â  Â  for (const part of parts) {
Â  Â  Â  Â  Â  Â  const arrayMatch = part.match(/(\w+)\[(\d+)\]/);
Â  Â  Â  Â  Â  Â  if (arrayMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  const key = arrayMatch[1];
Â  Â  Â  Â  Â  Â  Â  Â  const index = parseInt(arrayMatch[2]);
Â  Â  Â  Â  Â  Â  Â  Â  current = current[key];
Â  Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(current) || index >= current.length) return undefined;
Â  Â  Â  Â  Â  Â  Â  Â  current = current[index];
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  current = current[part];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (current === undefined || current === null) return undefined;
Â  Â  Â  Â  }
Â  Â  Â  Â  return current;
Â  Â  } catch (e) {
Â  Â  Â  Â  return undefined;
Â  Â  }
}
function compareValues(a, b, isNumeric) {
Â  Â  if (isNumeric) return Number(a) === Number(b);
Â  Â  return String(a) === String(b);
}
async function runSequence(arr,token){
Â  Â  for(let i=0;i<arr.length;i++){
Â  Â  Â  Â  if(runStopFlag){appendLog('å®Ÿè¡Œä¸­æ­¢');return;}
Â  Â  Â  Â  const b=arr[i];
Â  Â  Â  Â  appendLog(`-> [${i+1}/${arr.length}] ${b.type} ${summaryForBlock(b)}`);
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='comment'){
Â  Â  Â  Â  Â  Â  if(b.props&&b.props.text)appendLog(`COMMENT: ${b.props.text}`);
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='wait'){
Â  Â  Â  Â  Â  Â  const t=Number(b.props&&b.props.sec)||1;
Â  Â  Â  Â  Â  Â  appendLog(`WAIT ${t}s`);
Â  Â  Â  Â  Â  Â  await sleepMs(t*1000);
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='loop'){
Â  Â  Â  Â  Â  Â  const cnt=Number(b.props&&b.props.count)||1;
Â  Â  Â  Â  Â  Â  const next=arr[i+1];
Â  Â  Â  Â  Â  Â  if(!next){appendLog('LOOP: no next block');continue;}
Â  Â  Â  Â  Â  Â  appendLog(`LOOP x${cnt} -> ${summaryForBlock(next)}`);
Â  Â  Â  Â  Â  Â  for(let k=0;k<cnt;k++){
Â  Â  Â  Â  Â  Â  Â  Â  if(runStopFlag)return;
Â  Â  Â  Â  Â  Â  Â  Â  window._scratch_context.loop_index = k + 1;
Â  Â  Â  Â  Â  Â  Â  Â  await runSequence([next],token);
Â  Â  Â  Â  Â  Â  Â  Â  refreshContextView();
Â  Â  Â  Â  Â  Â  }
            delete window._scratch_context.loop_index;
Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='cond'){
Â  Â  Â  Â  Â  Â  const targetVar = b.props.variable || 'status';
Â  Â  Â  Â  Â  Â  const valueToCompare = b.props.value !== undefined ? b.props.value : b.props.code;
Â  Â  Â  Â  Â  Â  let actualValue;

Â  Â  Â  Â  Â  Â  if (targetVar === 'status') {
Â  Â  Â  Â  Â  Â  Â  Â  actualValue = window._scratch_last_status || 0;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  actualValue = window._scratch_context[targetVar];
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const isNumeric = !isNaN(Number(actualValue)) && !isNaN(Number(valueToCompare));
Â  Â  Â  Â  Â  Â  const conditionMet = compareValues(actualValue, valueToCompare, isNumeric);

Â  Â  Â  Â  Â  Â  appendLog(`COND check {{${targetVar}}}(${actualValue}) == ${valueToCompare}`);

Â  Â  Â  Â  Â  Â  if(conditionMet && Array.isArray(b.props.blocks)) {
Â  Â  Â  Â  Â  Â  Â  Â  await runSequence(b.props.blocks,token);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  appendLog('COND skipped');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='api'){
Â  Â  Â  Â  Â  Â  let method=(b.props.method||'GET').toUpperCase();
Â  Â  Â  Â  Â  Â  let path=injectVariables(b.props.path||'/users/@me', window._scratch_context);
Â  Â  Â  Â  Â  Â  let body=b.props.body!==undefined?b.props.body:null;
Â  Â  Â  Â  Â  Â  let headers=Object.assign({},b.props.headers||{});
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (body && typeof body === 'object') {
Â  Â  Â  Â  Â  Â  Â  Â  let bodyStr = JSON.stringify(body);
Â  Â  Â  Â  Â  Â  Â  Â  bodyStr = injectVariables(bodyStr, window._scratch_context);
Â  Â  Â  Â  Â  Â  Â  Â  try { body = JSON.parse(bodyStr); } catch(e) { appendLog('API ERROR: Body variable injection failed'); body = null; }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const opts={method,headers:Object.assign({'Authorization':token,'Content-Type':'application/json'},headers)};
Â  Â  Â  Â  Â  Â  if(body!==null&&['POST','PATCH','PUT','DELETE'].includes(method))opts.body=JSON.stringify(body);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const url='https://discord.com/api/v9'+path;
Â  Â  Â  Â  Â  Â  appendLog(`API ${method} ${path}`);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let resJson = null;

Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  const res=await fetchWithRetry(url,opts);
Â  Â  Â  Â  Â  Â  Â  Â  const txt=await res.text().catch(()=>null);
Â  Â  Â  Â  Â  Â  Â  Â  window._scratch_last_status=res.status;
Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[API res] ${res.status} ${txt?(txt.length>400?txt.slice(0,400)+'...':txt):''}`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (txt && res.headers.get('content-type') && res.headers.get('content-type').includes('application/json')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { resJson = JSON.parse(txt); } catch(e) { resJson = null; }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  Â  Â  Â  appendLog('API ERROR: '+e.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (b.props.extract && resJson) {
Â  Â  Â  Â  Â  Â  Â  Â  const extracted = extractValue(resJson, b.props.extract.path);
Â  Â  Â  Â  Â  Â  Â  Â  if (extracted !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window._scratch_context[b.props.extract.var] = extracted;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`EXTRACTED: ${b.props.extract.var} = ${extracted}`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`EXTRACT FAIL: Path ${b.props.extract.path} not found`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  refreshContextView();

Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  appendLog('Unknown block type: '+b.type);
Â  Â  }
}
$('btnExec').onclick = async ()=>{ if(!$('consentExec').checked){ alert('å®Ÿè¡Œå‰ã«åŒæ„ã—ã¦ãã ã•ã„'); return; } const sel = $('selectToken').value; if(!sel){ alert('Token ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } const token = DB.tokens[sel].token; const rec = $('exec_recipients').value.split(',').map(s=>s.trim()).filter(Boolean); if(rec.length < 2){ alert('Recipients ã¯2äººä»¥ä¸Šå¿…è¦ã§ã™'); return; } const name = $('exec_name').value.trim(); const count = Number($('exec_count').value) || 1; runStopFlag = false; $('btnStop').style.display='inline-block'; appendLog('é–‹å§‹: Create Group x'+count); for(let i=0;i<count;i++){ if(runStopFlag) break; try{ const res = await fetchWithRetry('https://discord.com/api/v9/users/@me/channels', { method:'POST', headers:{'Authorization':token,'Content-Type':'application/json'}, body: JSON.stringify({recipients:rec}) }); const jtxt = await res.text().catch(()=>null); appendLog(`[Create ${i+1}] ${res.status} ${jtxt? (jtxt.length>400? jtxt.slice(0,400)+'...': jtxt):''}`); window._scratch_last_status = res.status; if(res.ok && name){ let j = null; try{ j = JSON.parse(jtxt); }catch(e){} if(j && j.id){ const cid = j.id; const patchBody = {name: name + (count>1 ? `_${i+1}` : '')}; if(DB.icon) patchBody.icon = DB.icon; const pres = await fetchWithRetry('https://discord.com/api/v9/channels/'+cid, { method:'PATCH', headers:{'Authorization':token,'Content-Type':'application/json'}, body: JSON.stringify(patchBody) }); const ptxt = await pres.text().catch(()=>null); appendLog(`[PATCH ${cid}] ${pres.status} ${ptxt?ptxt.slice(0,400):''}`); window._scratch_last_status = pres.status; } else appendLog('channel id ãŒè¿”ã‚‰ãš name ã‚’ PATCH ã§ãã¾ã›ã‚“ã§ã—ãŸ'); } }catch(e){ appendLog('ERROR create: '+e.message); } } $('btnStop').style.display='none'; runStopFlag = false; appendLog('å®Œäº†'); };
$('runSeq').onclick = async ()=>{ const sel = $('selectToken').value; if(!sel){ alert('Token ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } if(!confirm('Sequence ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿï¼ˆè‡ªå·±è²¬ä»»ï¼‰')) return; const token = DB.tokens[sel].token; window._scratch_context = {}; runStopFlag = false; $('btnStop').style.display='inline-block'; $('scratchLog').textContent = ''; try{ const seq = workspaceToSequence(); await runSequence(seq, token); }catch(e){ appendLog('å®Ÿè¡Œä¸­æ–­: '+(e && e.message ? e.message : String(e))); } $('btnStop').style.display='none'; runStopFlag=false; appendLog('Sequence å®Ÿè¡Œçµ‚äº†'); refreshContextView(); };
// Tab Switching
$('tabExec').onclick = ()=>{ 
    $('viewExec').style.display='block'; 
    $('viewScratch').style.display='none'; 
    $('tabExec').classList.add('ok'); $('tabExec').classList.remove('ghost'); 
    $('tabScratch').classList.remove('ok'); $('tabScratch').classList.add('ghost'); 
    updateLayoutForTab(false);
};
$('tabScratch').onclick = ()=>{ 
    $('viewExec').style.display='none'; 
    $('viewScratch').style.display='block'; 
    $('tabExec').classList.remove('ok'); $('tabExec').classList.add('ghost'); 
    $('tabScratch').classList.add('ok'); $('tabScratch').classList.remove('ghost'); 
    if($('scratchLog').textContent === 'â€”') $('scratchLog').textContent = ''; 
    refreshContextView();
    updateLayoutForTab(true);
};
$('openScratch').onclick = ()=>{ $('tabScratch').click(); };

// Layout Toggling
$('toggleLayout').onclick = ()=>{ 
    if ($('workspace').classList.contains('vertical')) {
        $('workspace').classList.remove('vertical');
    } else {
        $('workspace').classList.add('vertical');
    }
    updateLayoutNotice(); 
};
function updateLayoutNotice(){ 
    const notice = $('layoutNotice'); 
    if($('workspace').classList.contains('vertical')) notice.textContent = 'ç¾åœ¨ï¼šç¸¦è¡¨ç¤º'; 
    else notice.textContent = 'ç¾åœ¨ï¼šæ¨ªè¡¨ç¤º'; 
}

function updateLayoutForTab(isScratch) {
    if (isScratch) {
        // rawAPIã‚¿ãƒ–ã®å ´åˆã€ãƒ‘ãƒ¬ãƒƒãƒˆã¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¡¨ç¤ºã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ¨ªãƒ•ãƒ­ãƒ¼ã‚’ç¶­æŒ
        $('palette').style.display = 'grid';
        $('workspace').style.display='flex';
        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã¯ç¸¦è¡¨ç¤ºã‚¯ãƒ©ã‚¹ãŒä»˜ã„ã¦ã„ãªã‘ã‚Œã°æ¨ªè¡¨ç¤ºã¨è¦‹ãªã™
        if (!$('workspace').classList.contains('vertical')) {
            $('workspace').classList.remove('vertical');
        }
    } else {
        // Executeã‚¿ãƒ–ã®å ´åˆã€éè¡¨ç¤º
        $('palette').style.display = 'none';
        $('workspace').style.display='none';
    }
    updateLayoutNotice();
}

$('exportSeq').onclick = ()=>{ const data = workspaceToSequence(); const text = JSON.stringify({exported:Date.now(), blocks:data}, null, 2); const blob = new Blob([text], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'sequence.json'; a.click(); URL.revokeObjectURL(url); };
$('importSeq').onclick = ()=>{ const f = document.createElement('input'); f.type='file'; f.accept='application/json'; f.onchange = ()=> { const file = f.files[0]; if(!file) return; const r = new FileReader(); r.onload = ()=> { try{ const j = JSON.parse(r.result); if(j.blocks && Array.isArray(j.blocks)) { loadSequenceObjectToWorkspace(j.blocks); alert('èª­ã¿è¾¼ã¿å®Œäº†'); } else alert('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«'); }catch(e){ alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'); } }; r.readAsText(file); }; f.click(); };
$('exportAll').onclick = ()=>{ const text = JSON.stringify({exported:Date.now(), db:DB}, null, 2); const blob = new Blob([text], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'gtools_full_export.json'; a.click(); URL.revokeObjectURL(url); };
$('importAll').onclick = ()=>{ const f = document.createElement('input'); f.type='file'; f.accept='application/json'; f.onchange = ()=> { const file = f.files[0]; if(!file) return; const r = new FileReader(); r.onload = ()=> { try{ const j = JSON.parse(r.result); if(j.db){ DB = j.db; saveDB(); alert('å…¨è¨­å®šã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ'); } else alert('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«'); }catch(e){ alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'); } }; r.readAsText(file); }; f.click(); };
$('btnGen').onclick = ()=>{ const sel = $('selectToken').value; if(!sel){ alert('Token ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } const token = DB.tokens[sel].token; const rec = $('exec_recipients').value.split(',').map(s=>s.trim()).filter(Boolean); if(rec.length < 2){ alert('Recipients ã¯2äººä»¥ä¸Šå¿…è¦ã§ã™'); return; } const jsonBody = JSON.stringify({recipients:rec}, null, 2); const curl = `curl -X POST "https://discord.com/api/v9/users/@me/channels" \\\n-H "Authorization: ${token}" \\\n-H "Content-Type: application/json" \\\n-d '${jsonBody.replace(/'/g, "\\'")}'`; const fetchCode = `fetch('https://discord.com/api/v9/users/@me/channels', {\nÂ  method: 'POST',\nÂ  headers: {\nÂ  Â  'Authorization': '${token}',\nÂ  Â  'Content-Type': 'application/json'\nÂ  },\nÂ  body: JSON.stringify({recipients: ${JSON.stringify(rec)}})\n})`; $('execLog').textContent = `[curl]\n${curl}\n\n[fetch]\n${fetchCode}`; };
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function loadInitial(){ 
    if(DB.icon){ $('iconPreview').src = DB.icon; $('iconInfo').textContent = 'Icon loaded'; } else { $('iconPreview').src = ''; $('iconInfo').textContent = 'No icon'; } 
    refreshTokenUI(); refreshTplUI(); refreshSeqList(); 
    
    // åˆæœŸè¡¨ç¤ºã¯Execã‚¿ãƒ–ãªã®ã§ã€Scratchè¦ç´ ã¯éè¡¨ç¤º
    $('viewScratch').style.display='none';
    updateLayoutForTab(false); 

    refreshContextView(); 
}
window.onload = loadInitial;
</script>
</body>
</html>
