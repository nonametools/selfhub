<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Group Tools â€” API Execute (V4: White Theme, Easy Use)</title>
<style>
/* ------------------------------------------------ */
/* â˜€ï¸ Light Theme v4 (Simplified Workflow) */
/* ------------------------------------------------ */
:root{
  --bg: #f5f7fa;             /* Main Light Background */
  --card: #ffffff;           /* Card Background (White) */
  --accent: #1f6feb;         /* Main Accent (Deep Blue) */
  --accent-dark: #104191;    /* Darker Accent for Contrast/Hover */
  --accent-light: #4c8fff;   /* Lighter Accent for Highlight */
  --muted: #6c757d;          /* Muted Text (Gray) */
  --text-primary: #212529;   /* Dark Text (High Contrast) */
  --ok: #28a745;             /* Success (Green) */
  --err: #dc3545;            /* Error (Red) */
  --block: #e9ecef;          /* Palette Block Background (Light Gray) */
  --block-contrast: #dee2e6; /* Workspace Block Background */
  --border: #dee2e6;         /* Border/Divider (Light Gray) */
  --border-strong: #ced4da; /* Stronger Border */
  --shadow: 0 4px 12px rgba(0,0,0,0.08); /* Light Shadow */
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text-primary);overflow:hidden;} 
header{
    display:flex;justify-content:space-between;align-items:center;padding:12px 20px;
    border-bottom:1px solid var(--border-strong);background:var(--card);flex-shrink:0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
h1{margin:0;font-size:22px;color:var(--text-primary)}
.sub{font-size:14px;color:var(--muted)}

/* å…¨ä½“ã‚³ãƒ³ãƒ†ãƒŠ: 3ã‚«ãƒ©ãƒ  (å·¦:220, ä¸­å¤®:1fr, å³:350) */
.main-layout{
    display: flex;
    height: calc(100vh - 68px); /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’å¼•ã */
    padding: 16px;
    gap: 16px;
    overflow: hidden; 
}
.col-info {
    width: 220px; /* æƒ…å ±/ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«ç‰¹åŒ– */
    flex-shrink: 0;
}
.col-main {
    flex-grow: 1; /* ä¸­å¤®ã‚’æœ€ã‚‚åºƒãã€å¯å¤‰ */
    min-width: 500px;
    display: flex;
    flex-direction: column;
}
.col-side {
    width: 350px; /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã€ãƒ­ã‚°ç®¡ç† */
    flex-shrink: 0;
}

/* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
.card{
    background:var(--card);
    padding:16px;
    border-radius:12px;
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    height: 100%; 
    box-sizing: border-box;
    display: flex;
    flex-direction: column; 
    overflow: hidden; 
}

/* ã‚¿ãƒ–ã‚¹ã‚¤ãƒƒãƒ */
.main-tabs{ display:flex; margin-bottom:16px; border-bottom:1px solid var(--border-strong); }
.main-tabs button {
    padding: 10px 15px; border: none; background: transparent; color: var(--muted);
    font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent;
    transition: color 0.2s, border-bottom-color 0.2s;
}
.main-tabs button.active {
    color: var(--accent); border-bottom-color: var(--accent);
}
#mainContentView {
    flex-grow: 1;
    overflow-y: auto; 
    padding: 0 16px 16px 16px;
}
#viewExec, #viewScratch { height: 100%; box-sizing: border-box; }

/* Components */
label{display:block;font-size:13px;color:var(--text-primary);font-weight:600;margin-top:10px}
input[type=text], input[type=password], textarea, select{
    width:100%;padding:8px;border-radius:6px;border:1px solid var(--border-strong);
    background:var(--block);color:var(--text-primary);box-sizing:border-box;
    transition:border-color 0.2s;font-size:14px;
}
input:focus, textarea:focus, select:focus {outline:none;border-color:var(--accent);background:#ffffff}
textarea{min-height:60px;resize:vertical}
.row{display:flex;gap:8px;align-items:center}
button{
    padding:8px 12px;border-radius:6px;border:none;background:var(--accent);
    color:white;cursor:pointer;font-weight:600;transition:background 0.2s;
}
button:hover{background:var(--accent-dark)}
button.ghost{background:transparent;border:1px solid var(--muted);color:var(--muted)}
button.ghost:hover{background:var(--block-contrast);color:var(--accent);border-color:var(--accent)}
button.small{padding:6px 10px;font-size:13px}
.danger{background:var(--err)}
.danger:hover{background:#c0303f}
.ok{background:var(--ok)}
.ok:hover{background:#218838}
.muted{color:var(--muted);font-size:12px}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.title{font-weight:700;color:var(--text-primary);margin-bottom:8px;font-size:16px}
.pill{
    display:inline-block;padding:4px 8px;border-radius:8px;
    background:var(--accent);font-size:13px;color:white;font-weight:600;
}

/* Token Select and Header */
#headerControls {
    display: flex; 
    align-items: center; 
    gap: 15px;
    padding: 5px 0;
}
#headerControls select { width: 150px; }

/* API Info List (Left Column) */
.info-list {
    margin-top: 10px;
    overflow-y: auto;
    flex-grow: 1;
}
.info-item {
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: background 0.2s;
    border: 1px solid transparent;
}
.info-item:hover { background: var(--block-contrast); border-color: var(--border-strong); }
.info-item.active { background: var(--accent-light); color: white; border-color: var(--accent); }
.info-item.active strong { color: white; }
.info-item strong { font-size: 14px; color: var(--accent-dark); }
.info-item .small { font-size: 12px; }

/* --- ç”»åƒã‚µã‚¤ã‚ºçµ±ä¸€ã®ãŸã‚ã®ä¿®æ­£ --- */
.img-preview { 
    width: 30px; 
    height: 30px; 
    border-radius: 50%; 
    object-fit: cover; 
    flex-shrink: 0; 
}
#execForm img { 
    margin-top: 10px; 
    border: 1px solid var(--border-strong); 
}
.list-container .item .img-preview {
    margin-top: 0; 
}
/* -------------------------------------- */

/* Sequence Builder (rawAPI) */
#scratchArea {
    display: grid;
    grid-template-columns: 80px 1fr; /* ç°¡ç•¥åŒ–ã—ãŸãƒ‘ãƒ¬ãƒƒãƒˆã¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ */
    gap: 16px;
    flex-grow: 1;
}
.palette {
    overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã— */
    background: var(--block);
    padding: 12px;
    border-radius: 8px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.palette .block {
    padding: 10px;
    width: 100%;
    text-align: center;
    background: var(--accent);
    color: white;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: grab;
    transition: background 0.2s;
    font-size: 20px; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚’æƒ³å®š */
}
.palette .block:hover { background: var(--accent-dark); }
#workspace {
    min-height: 300px;
    border: 2px dashed var(--border-strong);
    padding: 12px;
    border-radius: 8px;
    background: var(--block-contrast); /* ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®èƒŒæ™¯ã‚’å°‘ã—æ¿ƒã */
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto; 
    align-items: stretch;
}
.wblock{
    background:var(--card);
    padding:10px 15px;
    border-radius:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:grab;
    border:1px solid var(--border);
    box-shadow:0 0 0 0 transparent;
    transition:box-shadow 0.1s, background 0.2s;
}
.wblock:hover{box-shadow:0 0 0 2px var(--accent-light)}
.wblock.selected{box-shadow:0 0 0 2px var(--accent) !important;}
.wblock .meta{font-size:15px;font-weight:700;color:var(--accent)}
.wblock .summary{font-size:13px;color:var(--muted)}
.wblock .btns button { background: var(--block-contrast); color: var(--text-primary); border: 1px solid var(--border); }
.wblock .btns button:hover { background: var(--border); }
.wblock .btns .danger:hover { background: var(--err); color: white; }

/* Side Panel Tabs */
.side-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: 12px;
    flex-shrink: 0;
}
.side-tabs button {
    flex-grow: 1;
    background: transparent;
    color: var(--muted);
    border-radius: 0;
    border-bottom: 3px solid transparent;
}
.side-tabs button.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}

/* Config/Log within Side Panel */
.config-container {
    padding: 10px;
    border-radius: 8px;
    background: var(--block);
    margin-top: 10px;
    overflow-y: auto;
    flex-shrink: 0;
}
pre{
    background: #f8f9fa;
    padding:12px;
    border-radius:8px;
    color:var(--text-primary);
    overflow:auto;
    white-space:pre-wrap;
    border:1px solid var(--border-strong);
    font-size:12px;
    flex-grow: 1; 
    min-height: 150px;
}
#execLogContainer { margin-top: 15px; }

/* Execute View */
#execForm {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
#execForm > div:last-child { grid-column: 1 / -1; } /* Actions */


/* List Item Styles */
.list-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.list-container .item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--card);
}
</style>
</head>
<body>
<header>
  <div>
    <h1>Group Tools â€” Easy API</h1>
    <div class="sub">ç›´æ„Ÿçš„ã§å…¥åŠ›ã®å°‘ãªã„æ“ä½œã‚’è¿½æ±‚</div>
  </div>
  <div id="headerControls">
    <div class="row">
        <span class="pill" style="background:var(--ok)">Token:</span>
        <select id="selectToken"><option value="">--æœªé¸æŠ--</option></select>
    </div>
    <button id="tokenManagementBtn" class="small ghost">ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†</button>
  </div>
</header>

<div class="main-layout">
      <div class="col-info">
    <div class="card">
      <div class="title">ğŸ“‹ Active API Information</div>
      <div id="infoList" class="info-list">
          <div class="info-item active"><strong>API / Task Select</strong><div class="small">Main task menu</div></div>
          <div class="info-item"><strong>Current Variables</strong><div class="small">last_id: 123...</div></div>
          <div class="info-item"><strong>Saved Templates</strong><div class="small">template_A, template_B</div></div>
      </div>
    </div>
  </div>

      <div class="col-main card" style="padding:0; overflow:hidden;">
        <div class="main-tabs">
            <button id="tabExec" class="active">ğŸ‘¥ Group Creation (ç°¡æ˜“å®Ÿè¡Œ)</button>
            <button id="tabScratch">ğŸ› ï¸ Sequence Builder (é«˜åº¦ãªè‡ªå‹•åŒ–)</button>
        </div>

        <div id="mainContentView">
            <div id="viewExec" class="active-view">
                <div id="execForm">
                    <div>
                        <div class="title">Template Selection & Parameters</div>
                        <label>åˆ©ç”¨ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                        <select id="exec_template_select"><option value="">--ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ--</option></select>
                        
                        <label>Recipients (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                        <input id="exec_recipients" type="text" placeholder="æ‰‹å‹•å…¥åŠ›ã¾ãŸã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ãƒ­ãƒ¼ãƒ‰" />
                        
                        <label>Optional Group Name</label>
                        <input id="exec_name" type="text" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" />
                        
                        <label>Count (ä½œæˆæ•°)</label>
                        <input id="exec_count" type="number" value="1" min="1" />
                        
                        <div class="controls">
                            <button id="saveTemplate" class="small ok">ç¾åœ¨ã®è¨­å®šã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜</button>
                        </div>
                    </div>
                    
                    <div>
                        <div class="title">Preview & Confirmation</div>
                        <div class="row">
                            <img id="iconPreview" class="img-preview" alt="Icon" />
                            <div style="flex:1">
                                <label style="margin-top:0;">Group Icon</label>
                                <input id="iconFile" type="file" accept="image/*" class="small" />
                                <button id="removeIcon" class="small ghost" style="margin-top:5px">ã‚¢ã‚¤ã‚³ãƒ³å‰Šé™¤</button>
                            </div>
                        </div>
                        <label style="margin-top:15px"><input type="checkbox" id="consentExec" /> å®Ÿè¡Œãƒªã‚¹ã‚¯ã‚’ç†è§£ã—ã€åŒæ„ã—ã¾ã™</label>
                        <div class="controls">
                            <button id="btnExec" class="ok" style="font-size:16px;">ğŸš€ å®Ÿè¡Œ (Create Groups)</button>
                        </div>
                    </div>
                    
                    <div id="execLogContainer">
                        <div class="title">å®Ÿè¡Œãƒ­ã‚° / APIãƒ¬ã‚¹ãƒãƒ³ã‚¹</div>
                        <pre id="execLog">â€”</pre>
                    </div>
                </div>
            </div>
            
            <div id="viewScratch" style="display:none;">
                <div id="scratchTopControls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div class="row">
                        <input id="seqName" type="text" placeholder="Sequenceå" style="width:180px" />
                        <button id="saveSeq" class="small ok">Sequence ä¿å­˜</button>
                        <button id="runSeq" class="ok">å®Ÿè¡Œ</button>
                    </div>
                    <div class="controls" style="margin:0;">
                        <button id="clearWorkspace" class="ghost small">ã‚¯ãƒªã‚¢</button>
                        <button id="btnStop" class="danger small" style="display:none">åœæ­¢</button>
                    </div>
                </div>
                
                <div id="scratchArea">
                    <div class="palette">
                        <div class="title" style="font-size:14px; margin-top:0;">Blocks</div>
                        <div class="block" draggable="true" data-type="api" title="API Call">ğŸ“¡</div>
                        <div class="block" draggable="true" data-type="wait" title="Wait (Delay)">â±ï¸</div>
                        <div class="block" draggable="true" data-type="loop" title="Loop (Repeat)">ğŸ”</div>
                        <div class="block" draggable="true" data-type="cond" title="If Condition">â“</div>
                        <div class="block" draggable="true" data-type="comment" title="Comment">ğŸ’¬</div>
                    </div>
                    <div id="workspace" ondragover="event.preventDefault()">
                        <div class="muted" style="text-align:center; padding-top:50px">ã“ã“ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>
                    </div>
                </div>
            </div>
        </div>
  </div>
    
    <div class="col-side card">
        <div class="side-tabs">
            <button id="tabSideTemplates" class="active">ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
            <button id="tabSideSequences">âš™ï¸ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</button>
            <button id="tabSideConfig">ğŸ’¡ ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š/ãƒ­ã‚°</button>
        </div>

        <div class="side-content" style="flex-grow:1; overflow-y:auto; padding-top:5px;">
            <div id="sideTemplates" class="active">
                <div class="title">ä¿å­˜æ¸ˆ Group Templates (ã‚¯ãƒªãƒƒã‚¯ã§åˆ©ç”¨)</div>
                <div id="groupList" class="list-container" style="max-height: calc(100vh - 200px); overflow-y: auto;"></div>
            </div>
            
            <div id="sideSequences" style="display:none;">
                <div class="title">ä¿å­˜æ¸ˆ Sequences (ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ãƒ­ãƒ¼ãƒ‰)</div>
                <div id="seqList" class="list-container" style="max-height: calc(100vh - 200px); overflow-y: auto;"></div>
                <div class="controls">
                    <button id="exportSeq" class="small ghost">Export</button>
                    <button id="importSeq" class="small ghost">Import</button>
                </div>
            </div>

            <div id="sideConfig" style="display:none; height:100%; display:flex; flex-direction:column;">
                <div id="blockConfigWrap" style="display:none;">
                    <div class="title">Selected Block Configuration</div>
                    <div id="blockConfig" class="config-container" style="max-height: 250px;">é¸æŠã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç·¨é›†ã§ãã¾ã™</div>
                </div>
                
                <div class="title" style="margin-top:10px">Sequence Preview (JSON)</div>
                <pre id="seqPreview" style="max-height:100px; flex-shrink:0;">[]</pre>

                <div id="scratchLogContainer" style="flex-grow:1; display:flex; flex-direction:column;">
                    <div class="title" style="margin-top:10px">Current Variables (Context)</div>
                    <pre id="contextView" style="max-height:100px; min-height:50px; flex-shrink:0;">{}</pre>
                    <div class="title">Sequence Log</div>
                    <pre id="scratchLog" style="flex-grow:1;">â€”</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>Local only â€” tokens, templates & sequences saved to localStorage</footer>

<div id="tokenModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="card" style="width:400px; height:auto; padding:20px;">
        <div class="title">ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†</div>
        <label>Label</label><input id="modalTokenLabel" type="text" placeholder="label" />
        <label>Token</label><input id="modalTokenValue" type="password" placeholder="user token" />
        <div class="controls">
            <button id="modalSaveToken" class="small ok">ä¿å­˜</button>
            <button id="modalCloseToken" class="small ghost">é–‰ã˜ã‚‹</button>
            <button id="clearTokens" class="small danger">å…¨éƒ¨å‰Šé™¤</button>
        </div>
        <div class="muted" style="margin-top:15px">ä¿å­˜æ¸ˆãƒˆãƒ¼ã‚¯ãƒ³</div>
        <div id="tokenList" class="list-container" style="max-height:200px;"></div>
    </div>
</div>


<script>
const STORAGE_KEY = 'selfhub_rawapi_v2_light';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {tokens:{}, templates:{}, sequences:{}, icon:null}; }catch(e){ return {tokens:{}, templates:{}, sequences:{}, icon:null}; }}
function saveDB(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); }catch(e){} refreshTokenUI(); refreshTplUI(); refreshSeqList(); }
let DB = loadDB();
const $ = id => document.getElementById(id);
function logLineExec(s){ const el = $('execLog'); el.textContent = (el.textContent === 'â€”' ? '' : el.textContent) + '['+new Date().toLocaleTimeString()+'] ' + s + '\n'; el.scrollTop = el.scrollHeight; }
function logLineScratch(s){ const el = $('scratchLog'); el.textContent = (el.textContent === 'â€”' ? '' : el.textContent) + '['+new Date().toLocaleTimeString()+'] ' + s + '\n'; el.scrollTop = el.scrollHeight; }
function appendLog(s){ 
    const isScratch = $('viewScratch').style.display !== 'none';
    if (!isScratch) logLineExec(s); 
    if (isScratch) logLineScratch(s); 
}
$('iconFile').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ DB.icon = r.result; saveDB(); $('iconPreview').src = DB.icon; appendLog('Icon saved'); }; r.readAsDataURL(f); });
$('removeIcon').onclick = ()=>{ DB.icon = null; saveDB(); $('iconPreview').src=''; };
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// --- V3ã®Sequenceå®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ç¾¤ã‚’çµ±åˆ ---
function isJson(str) { try { JSON.parse(str); } catch (e) { return false; } return true; }

function injectVariables(input, context) {
    if (typeof input !== 'string') return input;
    const regex = /\{\{(\w+)\}\}/g;
    return input.replace(regex, (match, varName) => {
        const value = context[varName];
        if (value === undefined || value === null) {
            return match; 
        }
        return String(value);
    });
}

function extractValue(responseJson, path) {
    if (!responseJson || !path) return undefined;
    let parts = path.trim().replace(/^\./, ''); 
    
    if (parts.startsWith('[0]')) {
        if (Array.isArray(responseJson) && responseJson.length > 0) {
            responseJson = responseJson[0];
            parts = parts.substring(3).replace(/^\./, ''); 
        } else {
            return undefined; 
        }
    } else if (parts.startsWith('[0].')) {
         if (Array.isArray(responseJson) && responseJson.length > 0) {
            responseJson = responseJson[0];
            parts = parts.substring(4); 
        } else {
            return undefined; 
        }
    }
    
    if (!parts) return responseJson; 
    
    parts = parts.split('.');
    let current = responseJson;

    for (const part of parts) {
        if (current === undefined || current === null) return undefined;
        current = current[part];
    }
    return current;
}

async function fetchWithRetry(url, options, token) {
    const maxRetries = 3;
    const headers = options.headers || {};
    
    if (token) {
        headers['Authorization'] = token;
    }
    headers['Content-Type'] = 'application/json';

    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, { ...options, headers: headers });
            
            if (response.status === 429) {
                const retryAfter = Number(response.headers.get('Retry-After')) || 1;
                appendLog(`[API WARNING] 429 Rate Limit. Retrying in ${retryAfter} seconds...`);
                await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
                continue; 
            }
            return response; 
        } catch (error) {
            if (i < maxRetries - 1) {
                appendLog(`[API ERROR] Network error. Retrying in 2 seconds... (${error.message})`);
                await new Promise(resolve => setTimeout(resolve, 2000));
            } else {
                throw new Error(`APIã‚³ãƒ¼ãƒ«å¤±æ•— (${url}): ${error.message}`);
            }
        }
    }
    throw new Error('APIã‚³ãƒ¼ãƒ«ãŒæœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’è¶…éã—ã¾ã—ãŸã€‚');
}

function compareValues(a, b) {
    let valA = a;
    let valB = b;
    
    if (!isNaN(Number(valA)) && !isNaN(Number(valB))) {
        valA = Number(valA);
        valB = Number(valB);
    }
    
    return valA === valB;
}

let runStopFlag = false;
window._scratch_context = {}; 
function refreshContextView() { $('contextView').textContent = JSON.stringify(window._scratch_context, null, 2); }

async function runSequence(sequence, token) {
    const loopStack = [];
    let i = 0;
    window._scratch_context.status = undefined; // å®Ÿè¡Œã”ã¨ã«ãƒªã‚»ãƒƒãƒˆ

    while (i < sequence.length) {
        if (runStopFlag) {
            appendLog('Sequence å®Ÿè¡Œã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚Šåœæ­¢ã—ã¾ã—ãŸã€‚');
            return;
        }

        const block = sequence[i];
        const props = block.props || {};
        
        // ãƒ­ã‚°ã®å…ˆé ­ã«å®Ÿè¡Œä¸­ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¡¨ç¤º
        appendLog(`-> [${i + 1}/${sequence.length}] ${summaryForBlock(block)}`);

        switch (block.type) {
            case 'api':
                try {
                    const url = 'https://discord.com/api/v9' + injectVariables(props.path, window._scratch_context);
                    const method = props.method || 'GET';
                    
                    let bodyJson = null;
                    if (props.body) {
                        const bodyStr = injectVariables(JSON.stringify(props.body), window._scratch_context);
                        if (isJson(bodyStr)) {
                            bodyJson = JSON.parse(bodyStr);
                        } else {
                            throw new Error('Body JSON å±•é–‹å¾ŒãŒç„¡åŠ¹ã§ã™: ' + bodyStr);
                        }
                    }

                    const res = await fetchWithRetry(url, {
                        method: method,
                        body: bodyJson ? JSON.stringify(bodyJson) : null
                    }, token);

                    const jtxt = await res.text().catch(() => null);
                    let j = null;
                    let logDetails = '';

                    try {
                        j = jtxt && jtxt.trim() ? JSON.parse(jtxt) : null;
                    } catch (e) {
                        // JSONãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã®å ´åˆãªã©ï¼‰
                    }
                    
                    window._scratch_context.status = res.status; // statuså¤‰æ•°ã¨ã—ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ä¿å­˜
                    
                    if (j) {
                        logDetails = jtxt.length > 100 ? JSON.stringify(j).slice(0, 100) + '...' : jtxt;
                    } else if (jtxt) {
                         logDetails = jtxt.length > 100 ? jtxt.slice(0, 100) + '...' : jtxt;
                    } else {
                        logDetails = '(No Content)';
                    }
                    
                    appendLog(`[API res] ${res.status} ${logDetails}`);

                    // Extract Value å‡¦ç†
                    if (props.extract && props.extract.var && props.extract.path && j) {
                        const extracted = extractValue(j, props.extract.path);
                        if (extracted !== undefined) {
                            window._scratch_context[props.extract.var] = extracted;
                            appendLog(`[EXTRACT OK] ${props.extract.var} = ${extracted}`);
                        } else {
                            appendLog(`[EXTRACT FAIL] Path ${props.extract.path} not found`);
                        }
                        refreshContextView();
                    }
                } catch (e) {
                    appendLog(`[API CALL ERROR] ${e.message}`);
                    throw e; // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ä¸­æ–­
                }
                i++;
                break;

            case 'wait':
                const delay = (Number(props.sec) || 1) * 1000;
                appendLog(`Waiting for ${props.sec} seconds...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                i++;
                break;

            case 'loop':
                const currentLoop = loopStack[loopStack.length - 1];
                const count = Number(props.count) || 1;
                
                if (!currentLoop || currentLoop.start !== i) {
                    // æ–°ã—ã„ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
                    loopStack.push({ 
                        start: i, 
                        count: count, 
                        current: 0 
                    });
                    i++;
                } else {
                    // ãƒ«ãƒ¼ãƒ—ã®æœ«å°¾ã«åˆ°é” (ã¾ãŸã¯ç¶™ç¶š)
                    currentLoop.current++;
                    
                    if (currentLoop.current < count) {
                        // ç¶™ç¶š: ãƒ«ãƒ¼ãƒ—é–‹å§‹ä½ç½®ã«æˆ»ã‚‹
                        i = currentLoop.start + 1;
                        appendLog(`Loop ${currentLoop.current + 1}/${count} - Restarting...`);
                    } else {
                        // çµ‚äº†: ãƒ«ãƒ¼ãƒ—ã‚’ãƒãƒƒãƒ—ã—ã€æ¬¡ã«é€²ã‚€
                        loopStack.pop();
                        i++;
                        appendLog('Loop Finished.');
                    }
                }
                break;
                
            case 'cond':
                let conditionMet = false;
                const targetVar = props.variable || 'status';
                const requiredValue = props.value !== undefined ? props.value : props.code; 
                
                let actualValue;
                if (targetVar === 'status') {
                    actualValue = window._scratch_context.status;
                } else {
                    const varKey = injectVariables(`{{${targetVar}}}`, window._scratch_context);
                    actualValue = varKey !== `{{${targetVar}}}` ? window._scratch_context[varKey] : window._scratch_context[targetVar];
                }

                if (actualValue !== undefined && compareValues(actualValue, requiredValue)) {
                    conditionMet = true;
                    appendLog(`[CONDITION OK] ${targetVar} (${actualValue}) == ${requiredValue}`);
                } else {
                    appendLog(`[CONDITION FAIL] ${targetVar} (${actualValue}) != ${requiredValue}`);
                }

                if (conditionMet) {
                    i++; // æ¡ä»¶ãŒæº€ãŸã•ã‚ŒãŸã‚‰æ¬¡ã«é€²ã‚€
                } else {
                    // æ¡ä»¶ãŒæº€ãŸã•ã‚Œãªã„å ´åˆã€æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã«é€²ã‚€
                    i++; 
                }
                break;
                
            case 'comment':
                i++;
                break;

            default:
                appendLog(`[WARNING] Unknown block type: ${block.type}`);
                i++;
        }
    }
}
// --- Sequenceå®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ç¾¤ çµ±åˆçµ‚äº† ---


// --- Token Management (Modal) ---
$('tokenManagementBtn').onclick = () => $('tokenModal').style.display = 'flex';
$('modalCloseToken').onclick = () => $('tokenModal').style.display = 'none';

function refreshTokenUI(){ 
    const list = $('tokenList'); list.innerHTML=''; 
    const sel = $('selectToken'); sel.innerHTML='<option value="">--æœªé¸æŠ--</option>'; 
    Object.entries(DB.tokens||{}).forEach(([id,t])=>{ 
        const div = document.createElement('div'); div.className='item'; 
        div.innerHTML = `<div><strong>${escapeHtml(t.label||id)}</strong><div class="small">â€¢â€¢â€¢â€¢${t.token?t.token.slice(-6):'(empty)'}</div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useBtn small ok">é¸æŠ</button><button data-id="${id}" class="delBtn small danger">å‰Šé™¤</button></div>`; 
        list.appendChild(div); 
        const opt = document.createElement('option'); opt.value = id; opt.textContent = t.label||id; sel.appendChild(opt); 
    }); 
    Array.from(document.getElementsByClassName('useBtn')).forEach(b=> b.onclick = ()=> { 
        $('selectToken').value = b.dataset.id; 
        $('tokenModal').style.display = 'none';
        appendLog(`Token selected: ${DB.tokens[b.dataset.id].label}`);
    }); 
    Array.from(document.getElementsByClassName('delBtn')).forEach(b=> b.onclick = ()=> { 
        if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.tokens[b.dataset.id]; saveDB(); refreshTokenUI(); } 
    }); 
    // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
    if (DB.icon) $('iconPreview').src = DB.icon;
}
$('modalSaveToken').onclick = ()=>{ 
    const lbl = $('modalTokenLabel').value.trim(); 
    const tok = $('modalTokenValue').value.trim(); 
    if(!lbl||!tok){ alert('label ã¨ token ã‚’å…¥åŠ›'); return; } 
    const id = 't_'+Date.now(); DB.tokens = DB.tokens || {}; 
    DB.tokens[id] = {label:lbl, token:tok}; saveDB(); refreshTokenUI(); 
    $('modalTokenLabel').value=''; $('modalTokenValue').value=''; 
    appendLog(`Token saved: ${lbl}`);
};
$('clearTokens').onclick = ()=>{ if(confirm('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ DB.tokens={}; saveDB(); refreshTokenUI(); } };

// --- Template Management ---
function refreshTplUI(){ 
    const out = $('groupList'); out.innerHTML=''; 
    const selExec = $('exec_template_select');
    selExec.innerHTML='<option value="">--ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ--</option>'; 

    Object.entries(DB.templates||{}).forEach(([id,t])=>{ 
        const div = document.createElement('div'); div.className='item'; 
        const iconHtml = t.icon ? `<img src="${t.icon}" class="img-preview" />` : `<div class="img-preview" style="background:var(--block);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:10px;width:30px;height:30px">no</div>`;
        div.innerHTML = `<div style="display:flex;gap:8px;align-items:center">${iconHtml}<div><strong>${escapeHtml(t.label||id)}</strong><div class="small">${escapeHtml(t.name||'')} (${(t.users||[]).length} users)</div></div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useTpl small ok">åˆ©ç”¨</button><button data-id="${id}" class="delTpl small danger">âœ–</button></div>`; 
        out.appendChild(div); 
        
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = t.label;
        selExec.appendChild(opt);
    }); 
    
    selExec.onchange = (e) => applyTemplateToExec(e.target.value);
    
    Array.from(document.getElementsByClassName('useTpl')).forEach(b=> b.onclick = ()=> applyTemplateToExec(b.dataset.id) ); 
    Array.from(document.getElementsByClassName('delTpl')).forEach(b=> b.onclick = ()=> { 
        if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.templates[b.dataset.id]; saveDB(); refreshTplUI(); } 
    }); 
}

$('saveTemplate').onclick = ()=>{ 
    const label = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
    if (!label) return;
    const name = $('exec_name').value.trim(); 
    const users = $('exec_recipients').value.split(',').map(s=>s.trim()).filter(Boolean); 
    const count = parseInt($('exec_count').value)||1; 
    
    if(users.length < 2){ alert('Recipients ã¯2äººä»¥ä¸Šå¿…è¦ã§ã™'); return; } 
    
    const id = 'tpl_'+Date.now(); 
    DB.templates = DB.templates || {}; 
    DB.templates[id] = {label:label, name:name, users:users, count:count, icon: DB.icon || null}; 
    saveDB(); refreshTplUI(); 
    appendLog(`Template saved: ${label}`);
    switchSideTab('tabSideTemplates');
};

function applyTemplateToExec(id){ 
    const t = DB.templates[id]; 
    if(!t) {
        $('exec_recipients').value = '';
        $('exec_name').value = ''; 
        $('exec_count').value = '1';
        return;
    }
    $('exec_recipients').value = (t.users||[]).join(','); 
    $('exec_name').value = t.name||''; 
    $('exec_count').value = t.count||1; 
    $('exec_template_select').value = id;

    if(t.icon){ 
        DB.icon = t.icon; saveDB(); 
        $('iconPreview').src = DB.icon; 
    } 
    switchTabs('tabExec'); 
    appendLog(`Template loaded: ${t.label}`);
}

// --- Sequence Management ---
function refreshSeqList(){ 
    const out = $('seqList'); out.innerHTML=''; 
    Object.entries(DB.sequences||{}).forEach(([id,s])=>{ 
        const div = document.createElement('div'); div.className='item'; 
        div.innerHTML = `<div><strong>${escapeHtml(s.name||id)}</strong><div class="small">${(s.blocks||[]).length} blocks</div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useSeq small ok">ãƒ­ãƒ¼ãƒ‰</button><button data-id="${id}" class="runSeqNow small">å®Ÿè¡Œ</button><button data-id="${id}" class="delSeq small danger">âœ–</button></div>`; 
        out.appendChild(div); 
    }); 
    Array.from(document.getElementsByClassName('useSeq')).forEach(b=> b.onclick = ()=> { loadSequenceIntoWorkspace(b.dataset.id); switchTabs('tabScratch'); } ); 
    Array.from(document.getElementsByClassName('runSeqNow')).forEach(b=> b.onclick = ()=> { loadSequenceIntoWorkspace(b.dataset.id); switchTabs('tabScratch'); setTimeout(()=> $('runSeq').click(), 120); } ); 
    Array.from(document.getElementsByClassName('delSeq')).forEach(b=> b.onclick = ()=> { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.sequences[b.dataset.id]; saveDB(); refreshSeqList(); } }); 
}
$('saveSeq').onclick = ()=>{ 
    const name = $('seqName').value.trim(); 
    if(!name){ alert('Sequence name ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; } 
    const data = workspaceToSequence(); 
    if(data.length === 0){ alert('ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“'); return; } 
    const id = 'seq_'+Date.now(); DB.sequences = DB.sequences || {}; 
    DB.sequences[id] = {name:name, blocks:data}; saveDB(); refreshSeqList(); 
    $('seqName').value=''; 
    appendLog(`Sequence saved: ${name}`);
    switchSideTab('tabSideSequences'); 
};
const workspace = $('workspace');
let blockCounter = 0;
let selectedBlockEl = null;

function defaultBlockForType(type){ 
    if(type==='api') return {type:'api', props:{method:'POST', path:'/channels/{{channel_id}}/messages', body:{content:"hello"}, headers:{}, extract:null}}; 
    if(type==='wait') return {type:'wait', props:{sec:1}}; 
    if(type==='loop') return {type:'loop', props:{count:2}}; 
    if(type==='cond') return {type:'cond', props:{variable:'status', value:200}}; 
    if(type==='comment') return {type:'comment', props:{text:'Note'}}; 
    return {type:type, props:{}}; 
}
function summaryForBlock(obj){ 
    if(!obj) return ''; 
    if(obj.type==='api') return `${obj.props.method||'GET'} ${obj.props.path||'...'}${obj.props.extract && obj.props.extract.var ? ` (Save: ${obj.props.extract.var})` : ''}`; 
    if(obj.type==='wait') return `Wait ${obj.props.sec||1}s`; 
    if(obj.type==='loop') return `Loop ${obj.props.count||1} times`; 
    if(obj.type==='cond'){ 
        const val = obj.props.value !== undefined ? obj.props.value : obj.props.code || 200;
        return `IF {{${obj.props.variable}}} == ${val}`; 
    } 
    if(obj.type==='comment') return obj.props.text||''; 
    return ''; 
}
function makeWBlock(obj){ 
    const id = 'b_'+(++blockCounter); obj._id = id; 
    const el = document.createElement('div'); el.className='wblock'; el.draggable = true; el.dataset.id = id; 
    el.innerHTML = `<div><div class="meta">${escapeHtml(obj.type.toUpperCase())}</div><div class="summary">${escapeHtml(summaryForBlock(obj))}</div></div><div class="btns" style="display:flex; gap:5px;"><button class="small ghost editBtn" title="è¨­å®š">âš™ï¸</button><button class="small ghost upBtn" title="ä¸Šã¸">â–²</button><button class="small ghost downBtn" title="ä¸‹ã¸">â–¼</button><button class="small danger delBtn" title="å‰Šé™¤">âœ–</button></div>`; 
    el._data = obj; 
    el.addEventListener('dragstart', (e)=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', 'workspace:'+id); }); 
    el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); }); 
    el.addEventListener('click', (e)=> { e.stopPropagation(); selectBlock(el); } ); 
    el.querySelector('.editBtn').onclick = (ev)=>{ ev.stopPropagation(); selectBlock(el); openBlockConfig(el); }; 
    el.querySelector('.delBtn').onclick = (ev)=>{ ev.stopPropagation(); if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ el.remove(); refreshSeqPreview(); selectedBlockEl = null; $('blockConfigWrap').style.display = 'none'; } }; 
    el.querySelector('.upBtn').onclick = (ev)=>{ ev.stopPropagation(); const p = el.previousElementSibling; if(p) el.parentNode.insertBefore(el, p); refreshSeqPreview(); }; 
    el.querySelector('.downBtn').onclick = (ev)=>{ ev.stopPropagation(); const n = el.nextElementSibling; if(n && n.classList.contains('wblock')) el.parentNode.insertBefore(n, el); refreshSeqPreview(); }; 
    return el; 
}
Array.from(document.getElementsByClassName('block')).forEach((b, idx)=>{ 
    const t = b.dataset.type || ['api','wait','loop','cond','comment'][idx]; b.dataset.type = t; 
    b.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', 'palette:'+t); b.classList.add('dragging'); }); 
    b.addEventListener('dragend', ()=> b.classList.remove('dragging')); 
    b.addEventListener('dblclick', ()=> { 
        const el = makeWBlock(defaultBlockForType(t)); 
        workspace.appendChild(el); 
        refreshSeqPreview(); 
        selectBlock(el); 
        openBlockConfig(el); // è‡ªå‹•ã§è¨­å®šç”»é¢ã‚’é–‹ã
    }); 
});
workspace.addEventListener('drop', (e)=>{ 
    e.preventDefault(); const d = e.dataTransfer.getData('text/plain'); 
    const afterElement = getDragAfterElement(workspace, e.clientY); 
    if(!d) return; 
    if(d.startsWith('palette:')){ 
        const type = d.split(':')[1]; 
        const obj = defaultBlockForType(type); 
        const w = makeWBlock(obj); 
        if(afterElement) workspace.insertBefore(w, afterElement); else workspace.appendChild(w); 
        selectBlock(w); 
        openBlockConfig(w); 
        refreshSeqPreview(); 
    } else if(d.startsWith('workspace:')){ 
        const id = d.split(':')[1]; 
        const draggedElement = document.querySelector(`.wblock[data-id="${id}"]`); 
        if(draggedElement){ 
            if(afterElement) workspace.insertBefore(draggedElement, afterElement); else workspace.appendChild(draggedElement); 
            selectBlock(draggedElement);
        } refreshSeqPreview(); 
    } 
});
workspace.addEventListener('dragover', e=> e.preventDefault());
function getDragAfterElement(container, y){ 
    const draggableElements = [...container.querySelectorAll('.wblock:not(.dragging)')]; 
    return draggableElements.reduce((closest, child)=>{ 
        const rect = child.getBoundingClientRect(); 
        const offset = y - rect.top - child.offsetHeight/2; 
        if(offset < 0 && offset > closest.offset){ 
            return {offset:offset, element:child}; 
        }else{ 
            return closest; 
        } 
    }, {offset: -Infinity}).element; 
}
function selectBlock(el){ 
    if (selectedBlockEl) selectedBlockEl.classList.remove('selected');
    selectedBlockEl = el;
    el.classList.add('selected');
    openBlockConfig(el); 
}
function openBlockConfig(el){ 
    switchTabs('tabScratch'); 
    switchSideTab('tabSideConfig'); 

    const cfg = $('blockConfig'); 
    $('blockConfigWrap').style.display = 'block'; 
    cfg.innerHTML = ''; 
    const obj = el._data; 

    // Configuration UI generation
    if(obj.type==='api'){ 
        cfg.innerHTML = `<label>Method</label><input id="cfg_method" type="text" value="${escapeHtml(obj.props.method||'POST')}" /><label>Path ({{var}} ã‚’åˆ©ç”¨å¯)</label><input id="cfg_path" type="text" value="${escapeHtml(obj.props.path||'/users/@me')}" /><label>Body (JSON, {{var}} å¯)</label><textarea id="cfg_body" style="min-height:60px">${obj.props.body?escapeHtml(JSON.stringify(obj.props.body,null,2)):''}</textarea><div class="title" style="margin-top:10px">Extract Value</div><label>Save to variable</label><input id="cfg_extract_var" type="text" value="${escapeHtml(obj.props.extract?.var||'')}" placeholder="ä¾‹: channel_id" /><label>JSONPath</label><input id="cfg_extract_path" type="text" value="${escapeHtml(obj.props.extract?.path||'')}" placeholder="ä¾‹: id ã¾ãŸã¯ [0].token" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; 
    } else if(obj.type==='wait'){ 
        cfg.innerHTML = `<label>Seconds</label><input id="cfg_sec" type="number" value="${escapeHtml(String(obj.props.sec||1))}" min="0.1" step="0.1" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; 
    } else if(obj.type==='loop'){
        cfg.innerHTML = `<label>Count</label><input id="cfg_count" type="number" value="${escapeHtml(String(obj.props.count||2))}" min="1" /><div class="muted">ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã¾ã§ã‚’æŒ‡å®šå›æ•°ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚</div><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`;
    } else if(obj.type==='cond'){
        cfg.innerHTML = `<label>Target Variable</label><input id="cfg_var" type="text" value="${escapeHtml(obj.props.variable||'status')}" placeholder="status ã¾ãŸã¯ å¤‰æ•°å" /><label>Required Value</label><input id="cfg_value" type="text" value="${escapeHtml(String(obj.props.value !== undefined ? obj.props.value : obj.props.code || 200))}" placeholder="200 ã¾ãŸã¯ 'token_string'" /><div class="muted">æ¡ä»¶ãŒæº€ãŸã•ã‚Œãªã„å ´åˆã€æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã«é€²ã¿ã¾ã™ã€‚</div><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`;
    } else if(obj.type==='comment'){
        cfg.innerHTML = `<label>Comment Text</label><input id="cfg_text" type="text" value="${escapeHtml(obj.props.text||'Note')}" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`;
    }
    
    // Save button logic
    $('cfgSave').onclick = () => {
        const data = el._data.props;
        
        if (el._data.type === 'api') {
            data.method = $('cfg_method').value.toUpperCase();
            data.path = $('cfg_path').value;
            try {
                const bodyVal = $('cfg_body').value.trim();
                data.body = bodyVal ? JSON.parse(bodyVal) : null;
            } catch(e) {
                alert('Body JSONãŒä¸æ­£ã§ã™: ' + e.message);
                return;
            }
            const exVar = $('cfg_extract_var').value.trim();
            const exPath = $('cfg_extract_path').value.trim();
            if (exVar && exPath) {
                data.extract = { var: exVar, path: exPath };
            } else {
                data.extract = null;
            }
        } else if (el._data.type === 'wait') {
            data.sec = Number($('cfg_sec').value) || 1;
        } else if (el._data.type === 'loop') {
            data.count = Number($('cfg_count').value) || 2;
        } else if (el._data.type === 'cond') {
            data.variable = $('cfg_var').value;
            // æ•°å€¤ã¨æ–‡å­—åˆ—ã‚’åŒºåˆ¥ã›ãšä¿å­˜
            data.value = $('cfg_value').value; 
            if (data.variable === 'status' && !isNaN(Number(data.value))) {
                 data.value = Number(data.value);
            }
            delete data.code; // codeã¯æ—§äº’æ›æ€§ã®ãŸã‚
        } else if (el._data.type === 'comment') {
            data.text = $('cfg_text').value;
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
        el.querySelector('.summary').textContent = summaryForBlock(el._data);
        refreshSeqPreview();
        appendLog(`Block ${el._data.type} updated.`);
    };
}
function workspaceToSequence(){ 
    const arr = []; 
    Array.from(workspace.children).forEach(c=>{ 
        if(c.classList.contains('wblock')) arr.push(c._data); 
    }); 
    return arr; 
}
function loadSequenceIntoWorkspace(id){
    const s = DB.sequences[id];
    if(!s || !s.blocks) return;
    $('workspace').innerHTML = ''; 
    $('seqName').value = s.name;
    s.blocks.forEach(b=>{
        const w = makeWBlock(b);
        workspace.appendChild(w);
    });
    refreshSeqPreview();
    appendLog(`Sequence loaded: ${s.name}`);
}
$('clearWorkspace').onclick = ()=>{ 
    if(confirm('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        workspace.innerHTML = '<div class="muted" style="text-align:center; padding-top:50px">ã“ã“ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>';
        $('seqName').value = '';
        selectedBlockEl = null;
        $('blockConfigWrap').style.display = 'none';
        $('seqPreview').textContent = '[]';
        appendLog('Workspace cleared.');
    }
};
function refreshSeqPreview(){ $('seqPreview').textContent = JSON.stringify(workspaceToSequence(),null,2); }


// --- Tab Management ---
function switchTabs(activeTabId){
    const tabs = ['tabExec', 'tabScratch'];
    const views = ['viewExec', 'viewScratch'];
    tabs.forEach(id => $(id).classList.remove('active'));
    views.forEach(id => $(id).style.display = 'none');

    const viewId = activeTabId === 'tabExec' ? 'viewExec' : 'viewScratch';
    $(activeTabId).classList.add('active');
    $(viewId).style.display = 'block';
}
function switchSideTab(activeTabId){
    const tabs = ['tabSideTemplates', 'tabSideSequences', 'tabSideConfig'];
    const views = ['sideTemplates', 'sideSequences', 'sideConfig'];
    tabs.forEach(id => $(id).classList.remove('active'));
    views.forEach(id => $(id).style.display = 'none');

    const viewId = activeTabId.replace('tabSide', 'side');
    $(activeTabId).classList.add('active');
    $(viewId).style.display = 'flex'; // sideConfigã¯flex
}
$('tabExec').onclick = () => switchTabs('tabExec');
$('tabScratch').onclick = () => switchTabs('tabScratch');
$('tabSideTemplates').onclick = () => switchSideTab('tabSideTemplates');
$('tabSideSequences').onclick = () => switchSideTab('tabSideSequences');
$('tabSideConfig').onclick = () => switchSideTab('tabSideConfig');


// --- Group Creation (ç°¡æ˜“å®Ÿè¡Œ) ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
$('btnExec').onclick = async ()=>{ 
    if(!$('consentExec').checked){ alert('å®Ÿè¡Œå‰ã«åŒæ„ã—ã¦ãã ã•ã„'); return; } 
    const sel = $('selectToken').value; 
    if(!sel){ alert('Token ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } 
    const token = DB.tokens[sel].token; 
    const rec = $('exec_recipients').value.split(',').map(s=>s.trim()).filter(Boolean); 
    if(rec.length < 2){ alert('Recipients ã¯2äººä»¥ä¸Šå¿…è¦ã§ã™'); return; } 
    const name = $('exec_name').value.trim(); 
    const count = Number($('exec_count').value) || 1; 

    runStopFlag = false; 
    $('execLog').textContent = '';
    appendLog('é–‹å§‹: Create Group x'+count); 
    
    $('btnStop').style.display='inline-block'; // ç°¡æ˜“å®Ÿè¡Œã§ã‚‚åœæ­¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    
    for(let i=0;i<count;i++){ 
        if(runStopFlag) break; 
        try{ 
            // 1. ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆä½œæˆ
            const res = await fetchWithRetry('https://discord.com/api/v9/users/@me/channels', { 
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body: JSON.stringify({recipients:rec}) 
            }, token); 

            const jtxt = await res.text().catch(()=>null); 
            logLineExec(`[Create ${i+1}] ${res.status} ${jtxt? (jtxt.length>400? jtxt.slice(0,400)+'...': jtxt):''}`); 
            
            if(res.ok && (name || DB.icon)){ 
                let j = null; try{ j = JSON.parse(jtxt); }catch(e){} 
                if(j && j.id){ 
                    const cid = j.id; 
                    const patchBody = {};
                    if(name) patchBody.name = name + (count>1 ? `_${i+1}` : ''); 
                    if(DB.icon) patchBody.icon = DB.icon; 
                    
                    // 2. ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆå/ã‚¢ã‚¤ã‚³ãƒ³ã®PATCH
                    const pres = await fetchWithRetry('https://discord.com/api/v9/channels/'+cid, { 
                        method:'PATCH', headers:{'Content-Type':'application/json'}, 
                        body: JSON.stringify(patchBody) 
                    }, token);

                    const ptxt = await pres.text().catch(()=>null); 
                    logLineExec(`[PATCH ${cid}] ${pres.status} ${ptxt?ptxt.slice(0,400):''}`); 
                } else logLineExec('channel id ãŒè¿”ã‚‰ãš name/icon ã‚’ PATCH ã§ãã¾ã›ã‚“ã§ã—ãŸ'); 
            } 
        }catch(e){ logLineExec('ERROR create: '+e.message); } 
        // é€£ç¶šå®Ÿè¡Œã®é–“ã«çŸ­ã„å¾…ã¡æ™‚é–“ã‚’å…¥ã‚Œã‚‹ï¼ˆãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆå¯¾ç­–ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    runStopFlag = false; 
    $('btnStop').style.display='none';
    appendLog('å®Œäº†'); 
};

// --- Sequence Builder (é«˜åº¦ãªå®Ÿè¡Œ) ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
$('runSeq').onclick = async ()=>{ 
    const sel = $('selectToken').value; 
    if(!sel){ alert('Token ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } 
    if(!confirm('Sequence ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿï¼ˆè‡ªå·±è²¬ä»»ï¼‰')) return; 
    const token = DB.tokens[sel].token; 
    window._scratch_context = {}; 
    runStopFlag = false; 
    $('btnStop').style.display='inline-block'; 
    $('scratchLog').textContent = ''; 
    refreshContextView();
    try{ 
        const seq = workspaceToSequence(); 
        await runSequence(seq, token); 
    }catch(e){ 
        appendLog('å®Ÿè¡Œä¸­æ–­: '+(e && e.message ? e.message : String(e))); 
    } 
    $('btnStop').style.display='none'; 
    runStopFlag=false; 
    appendLog('Sequence å®Ÿè¡Œçµ‚äº†'); 
    refreshContextView(); 
};
$('btnStop').onclick = ()=>{ runStopFlag = true; $('btnStop').style.display='none'; appendLog('åœæ­¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ'); };


// --- Initial Load ---
document.addEventListener('DOMContentLoaded', ()=>{
    refreshTokenUI();
    refreshTplUI();
    refreshSeqList();
    refreshSeqPreview(); // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã‚‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åˆæœŸåŒ–
});

</script>
</body>
</html>
