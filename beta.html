<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Group Tools â€” API Execute (V3 Optimized for Workflow)</title>
<style>
/* ------------------------------------------------ */
/* ğŸŒ™ Dark Theme v6 (Workflow Optimized Layout) */
/* ------------------------------------------------ */
:root{
  --bg: #071224;            /* Main Dark Background */
  --card: #0f1720;          /* Card Background */
  --accent: #1f6feb;        /* Main Accent (Deep Blue) */
  --accent-dark: #104191;   /* Darker Accent for Contrast/Hover */
  --accent-light: #5998ff;  /* Lighter Accent for Text/Highlight */
  --muted: #7fa3c7;         /* Muted Text */
  --text-primary: #e6eef8;  /* Light Text (High Contrast) */
  --ok: #2db85a;            /* Success (Green) */
  --err: #e04d4d;           /* Error (Red) */
  --block: #112033;         /* Palette Block Background */
  --block-contrast: #16324b;/* Workspace Block Background (Higher Contrast) */
  --border: rgba(255,255,255,0.05); /* Border/Divider */
  --border-strong: rgba(255,255,255,0.1); /* Stronger Border */
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text-primary);overflow:hidden;} 
header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;border-bottom:1px solid var(--border-strong);background:var(--card);flex-shrink:0}
h1{margin:0;font-size:18px;color:var(--accent-light)}
.sub{font-size:12px;color:var(--muted)}

/* å…¨ä½“ã‚³ãƒ³ãƒ†ãƒŠ: 3ã‚«ãƒ©ãƒ  (å·¦:250, ä¸­å¤®:1fr, å³:350) */
.main-layout{
  display: flex;
  height: calc(100vh - 58px); /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’å¼•ã */
  padding: 16px;
  gap: 16px;
  overflow: hidden; 
}
.col-tokens {
    width: 250px; /* ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã«ç‰¹åŒ– */
    flex-shrink: 0;
}
.col-main {
    flex-grow: 1; /* ä¸­å¤®ã‚’æœ€ã‚‚åºƒãã€å¯å¤‰ */
    min-width: 500px;
    display: flex;
    flex-direction: column;
}
.col-side {
    width: 350px; /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã€ãƒ­ã‚°ç®¡ç† */
    flex-shrink: 0;
}

/* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
.card{
    background:var(--card);
    padding:16px;
    border-radius:12px;
    border:1px solid var(--border);
    box-shadow:0 6px 24px rgba(0,0,0,0.6);
    height: 100%; 
    box-sizing: border-box;
    display: flex;
    flex-direction: column; /* å†…éƒ¨è¦ç´ ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
    overflow: hidden; /* å†…éƒ¨ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç®¡ç† */
}

/* ä¸­å¤®ã‚«ãƒ©ãƒ ã®ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ */
#mainContentView {
    flex-grow: 1;
    overflow-y: auto; /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    padding: 16px;
}
#viewExec, #viewScratch {
    height: 100%;
    box-sizing: border-box;
}

/* Tokens, Templates, Sequences ã®ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
.list-container {
    flex-grow: 1;
    overflow-y: auto;
    margin-top: 10px;
}
.list-small {
    max-height: 200px; 
    overflow-y: auto;
    margin-top:8px;
}
.item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;transition:background 0.2s}
.item:hover{background:rgba(255,255,255,0.04)}
.item:last-child{border-bottom:none}
.item strong{color:var(--accent-light)}

/* Form & Components */
label{display:block;font-size:13px;color:var(--accent-light);font-weight:600;margin-top:10px}
input[type=text], input[type=password], textarea, select{width:100%;padding:8px;border-radius:6px;border:1px solid var(--border);background:rgba(255,255,255,0.03);color:var(--text-primary);box-sizing:border-box;transition:border-color 0.2s;font-size:14px}
input:focus, textarea:focus, select:focus {outline:none;border-color:var(--accent);background:var(--block-contrast)}
textarea{min-height:60px;resize:vertical}
.row{display:flex;gap:8px;align-items:center}
button{padding:8px 12px;border-radius:6px;border:none;background:var(--accent);color:white;cursor:pointer;font-weight:600;transition:background 0.2s}
button:hover{background:var(--accent-dark)}
button.ghost{background:transparent;border:1px solid var(--muted);color:var(--muted)}
button.ghost:hover{background:var(--block-contrast);color:var(--accent-light);border-color:var(--accent)}
button.small{padding:6px 10px;font-size:13px}
.danger{background:var(--err)}
.danger:hover{background:#b82b2b}
.ok{background:var(--ok)}
.ok:hover{background:#238c46}
.muted{color:var(--muted);font-size:12px}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.title{font-weight:700;color:var(--accent-light);margin-bottom:8px;font-size:15px}
.pill{display:inline-block;padding:4px 8px;border-radius:8px;background:var(--block);font-size:13px;color:var(--text-primary);font-weight:600}

/* Execute View */
#viewExec {
    display: grid;
    grid-template-columns: 1fr 1fr; /* ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒ­ã‚°ã‚’å·¦å³åˆ†å‰² */
    gap: 20px;
    align-items: flex-start;
}
#execForm{ padding-right: 10px; }
#execLogContainer{
    display: flex;
    flex-direction: column;
    height: 100%;
}
#execLogContainer .title{ margin-top:0; }
pre{
    background:#031324;padding:12px;border-radius:8px;color:#cfefff;overflow:auto;
    white-space:pre-wrap;border:1px solid var(--border);font-size:12px;
    flex-grow: 1; 
    min-height: 250px;
}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* rawAPI View */
#viewScratch {
    display: flex;
    flex-direction: column;
    height: 100%;
}
#scratchTopControls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    flex-shrink: 0;
}
#scratchArea {
    display: grid;
    grid-template-columns: 200px 1fr; /* ãƒ‘ãƒ¬ãƒƒãƒˆã¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ */
    gap: 16px;
    flex-grow: 1;
}
.palette {
    overflow-y: auto;
    background: var(--block);
    padding: 12px;
    border-radius: 8px;
    flex-shrink: 0;
}
.palette .block {
    padding: 8px;
    background: var(--accent-dark);
    color: white;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: grab;
    transition: background 0.2s;
}
.palette .block:hover { background: var(--accent); }
#workspace {
    min-height: 300px;
    border: 2px dashed var(--muted);
    padding: 12px;
    border-radius: 8px;
    background: rgba(255,255,255,0.01);
    display: flex;
    gap: 10px;
    overflow: auto; 
    flex-grow: 1;
}
#workspace:not(.vertical) { 
    flex-direction: row;
    flex-wrap: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    align-items: flex-start;
}
#workspace.vertical {
    flex-direction: column;
    flex-wrap: nowrap;
    overflow-x: hidden;
    overflow-y: auto;
    align-items: stretch;
}
.wblock{background:var(--block-contrast);padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:grab;min-width:280px;border:1px solid var(--border);box-shadow:0 0 0 0 transparent;transition:box-shadow 0.1s, background 0.2s}
#workspace:not(.vertical) .wblock{flex-shrink:0}
#workspace.vertical .wblock{margin-bottom:8px;}
.wblock:hover{box-shadow:0 0 0 1px var(--accent-light)}
.wblock .meta{font-size:14px;font-weight:700;color:var(--accent-light)}
.wblock .small{font-size:12px;color:var(--muted)}
.wblock.dragging{opacity:0.6}

/* å³ã‚«ãƒ©ãƒ  (Side Panel) Tab View */
.side-tabs {
    display: flex;
    margin-bottom: 12px;
    flex-shrink: 0;
}
.side-tabs button {
    flex-grow: 1;
    background: var(--block-contrast);
    border-radius: 0;
    margin: 0;
    border-bottom: 3px solid transparent;
}
.side-tabs button.active {
    background: var(--card);
    border-bottom-color: var(--accent-light);
    color: white;
}
.side-content {
    flex-grow: 1;
    overflow: hidden;
    padding-top: 5px;
}
#sideTemplates, #sideSequences, #sideLogConfig {
    height: 100%;
    overflow-y: auto;
    display: none;
}
#sideTemplates.active, #sideSequences.active, #sideLogConfig.active {
    display: block;
}

/* Config/Log within Side Panel */
.config-container {
    padding: 10px;
    border-radius: 8px;
    background: var(--block);
    margin-top: 10px;
    overflow-y: auto;
    max-height: 40%; 
    flex-shrink: 0;
}
#scratchLogContainer {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    margin-top: 10px;
}
#contextView { min-height: 50px; max-height: 120px; flex-shrink: 0;}
#scratchLog { flex-grow: 1; min-height: 100px; }

/* ãã®ä»– */
.img-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border); }
@media (max-width: 1200px){ 
  .main-layout{ flex-direction: column; height: auto; overflow-y: auto; } 
  .col-tokens, .col-main, .col-side { width: 100%; flex-shrink: 1; }
  .card{ height: auto; min-height: 300px; }
  #viewExec { grid-template-columns: 1fr; }
  #scratchArea { grid-template-columns: 1fr; }
  .palette { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: auto; }
}
</style>
</head>
<body>
<header>
Â  <div>
Â  Â  <h1>.,/?(~^=Â  Group Tools â€” API Execute (V3)Â  =^~)?\,. </h1>
Â  Â  <div class="sub">æœ€å„ªå…ˆã§ä½¿ã„ã‚„ã™ã•ã‚’è¿½æ±‚ã—ãŸè¨­è¨ˆ</div>
Â  </div>
Â  <div class="row">
Â  Â  <span class="pill">Select Token:</span>
Â  Â  <select id="selectToken"><option value="">--é¸æŠ--</option></select>
Â  </div>
</header>

<div class="main-layout">
    Â  <div class="col-tokens">
Â  Â  <div class="card">
Â  Â  Â  <div class="title">ğŸ”‘ Token Management</div>
Â  Â  Â  <label>Label</label><input id="tokenLabel" type="text" placeholder="label" />
Â  Â  Â  <label>Token</label><input id="tokenValue" type="password" placeholder="user token" />
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <button id="saveToken" class="small ok">ä¿å­˜</button>
Â  Â  Â  Â  <button id="clearTokens" class="small danger">å…¨éƒ¨å‰Šé™¤</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="muted" style="margin-top:12px">ä¿å­˜æ¸ˆãƒˆãƒ¼ã‚¯ãƒ³ (ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ)</div>
Â  Â  Â  <div id="tokenList" class="list-container"></div>
Â  Â  </div>
Â  </div>

    Â  <div class="col-main card" style="padding:0; overflow:hidden;">
        <div class="side-tabs">
            <button id="tabExec" class="active">ğŸš€ API Execute</button>
            <button id="tabScratch">ğŸ§± rawAPI Builder</button>
        </div>

        <div id="mainContentView">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="viewExec" class="active-view">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="execForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title">Execution Parameters</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Recipients (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="exec_recipients" type="text" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Optional Group Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="exec_name" type="text" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Count</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="exec_count" type="text" value="1" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title" style="margin-top:20px">Actions</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label><input type="checkbox" id="consentExec" /> å®Ÿè¡Œãƒªã‚¹ã‚¯ã‚’ç†è§£ã—ã¾ã—ãŸ</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnExec" class="ok">å®Ÿè¡Œ (Create Group)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnStop" class="danger" style="display:none">åœæ­¢</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnGen" class="ghost">curl/fetch ç”Ÿæˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div id="execLogContainer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title">Log / Response</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <pre id="execLog">â€”</pre>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="viewScratch" style="display:none;">
                <div id="scratchTopControls">
                    <div class="row">
                        <input id="seqName" type="text" placeholder="Sequence Name for Save" style="width:200px" />
                        <button id="saveSeq" class="small ok">Sequence ä¿å­˜</button>
                    </div>
                    <div class="controls">
                        <button id="runSeq" class="ok">å®Ÿè¡Œ</button>
                        <button id="clearWorkspace" class="ghost">ã‚¯ãƒªã‚¢</button>
                        <button id="toggleLayout" class="ghost">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡æ›¿</button>
                    </div>
                </div>
                <div id="scratchArea">
                    <div class="palette">
                        <div class="title" style="margin-top:0">Blocks Palette</div>
                        <div class="block" draggable="true" data-type="api">API Call (Request)</div>
                        <div class="block" draggable="true" data-type="wait">Wait (Delay)</div>
                        <div class="block" draggable="true" data-type="loop">Loop (Repeat Next)</div>
                        <div class="block" draggable="true" data-type="cond">If Condition (Status/Var)</div>
                        <div class="block" draggable="true" data-type="comment">Comment / Note</div>
                    </div>
                    <div id="workspace" ondragover="event.preventDefault()">
                        <div class="muted" style="text-align:center; padding-top:50px">ã“ã“ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>
                    </div>
                </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  </div>
    
    <div class="col-side card">
        <div class="side-tabs" style="margin-bottom:0;">
            <button id="tabSideTemplates" class="active">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
            <button id="tabSideSequences">ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</button>
            <button id="tabSideLogsConfig">ãƒ­ã‚° / è¨­å®š</button>
        </div>

        <div class="side-content">
            <div id="sideTemplates" class="active">
                <div class="title">ğŸ“ Group Templates</div>
                <label>è¨­å®š Label</label><input id="gLabel" type="text" placeholder="group-1" />
                <label>Group åï¼ˆè¡¨ç¤ºåï¼‰</label><input id="gName" type="text" placeholder="groupname" />
                <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label><input id="gUsers" type="text" placeholder="123,456,789" />
                <label>ä½œæˆæ•°</label><input id="gCount" type="text" value="1" />
                <div class="controls" style="margin-top:8px">
                    <button id="saveGroup" class="small ok">ä¿å­˜</button>
                    <button id="refreshGroups" class="small ghost">ä¸€è¦§æ›´æ–°</button>
                </div>
                <div class="muted" style="margin-top:12px">ä¿å­˜æ¸ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (åˆ©ç”¨ã§ `Execute` ç”»é¢ã¸è‡ªå‹•å…¥åŠ›)</div>
                <div id="groupList" class="list-container"></div>
            </div>
            
            <div id="sideSequences">
                <div class="title">Saved Sequences</div>
                <div id="seqList" class="list-container"></div>
                <div class="muted" style="margin-top:10px">
                    Sequence ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
                    **èª­ã¿è¾¼ã¿:** rawAPIç”»é¢ã¸åæ˜ ã€‚<br>
                    **å®Ÿè¡Œ:** rawAPIç”»é¢ã§ç›´æ¥å®Ÿè¡Œã€‚
                </div>
                <div class="controls">
                    <button id="exportSeq" class="small">Seq Export</button>
                    <button id="importSeq" class="small ghost">Seq Import</button>
                </div>
            </div>

            <div id="sideLogConfig" style="display:flex; flex-direction:column;">
                <div id="blockConfigWrap" style="display:none;">
                    <div class="title">Selected Block Config</div>
                    <div id="blockConfig" class="config-container">é¸æŠã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç·¨é›†ã§ãã¾ã™</div>
                </div>
                
                <div class="title" style="margin-top:10px">Sequence Preview (JSON)</div>
                <pre id="seqPreview" style="max-height:100px; flex-shrink:0;">[]</pre>

                <div id="scratchLogContainer">
                    <div class="title">Current Variables (Context)</div>
                    <pre id="contextView" style="max-height:120px;">{}</pre>
                    <div class="title">rawAPI Log</div>
                    <pre id="scratchLog">â€”</pre>
                </div>

                <div class="title" style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">Global Data / Icon</div>
                <div class="controls">
                    <button id="exportAll" class="small">å…¨è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="importAll" class="small ghost">å…¨è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
                <label style="margin-top:10px">Icon for Group Templates</label>
                <input id="iconFile" type="file" accept="image/*" />
                <div class="row" style="margin-top:12px">
                    <img id="iconPreview" class="img-preview" alt="" />
                    <div style="flex:1">
                        <div class="small" id="iconInfo">No icon</div>
                        <div style="margin-top:8px" class="controls">
                            <button id="removeIcon" class="small ghost">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>Local only â€” tokens, templates & sequences saved to localStorage</footer>

<script>
// (å‰å›ã®ã‚³ãƒ¼ãƒ‰ã®JavaScriptã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¾ã™ãŒã€ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã®ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿å¤‰æ›´ã—ã¾ã™)
// ... [START of JavaScript block - å¤šãã®ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã—] ...
const STORAGE_KEY = 'selfhub_rawapi_v1';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {tokens:{}, templates:{}, sequences:{}, icon:null}; }catch(e){ return {tokens:{}, templates:{}, sequences:{}, icon:null}; }}
function saveDB(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); }catch(e){} refreshTokenUI(); refreshTplUI(); refreshSeqList(); }
let DB = loadDB();
const $ = id => document.getElementById(id);
function logLineExec(s){ const el = $('execLog'); el.textContent = (el.textContent === 'â€”' ? '' : el.textContent) + '['+new Date().toLocaleTimeString()+'] ' + s + '\n'; el.scrollTop = el.scrollHeight; }
function logLineScratch(s){ const el = $('scratchLog'); el.textContent = (el.textContent === 'â€”' ? '' : el.textContent) + '['+new Date().toLocaleTimeString()+'] ' + s + '\n'; el.scrollTop = el.scrollHeight; }
function appendLog(s){ logLineExec(s); if($('viewScratch').style.display !== 'none') logLineScratch(s); }
$('iconFile').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ DB.icon = r.result; saveDB(); $('iconPreview').src = DB.icon; $('iconInfo').textContent = 'Icon loaded'; appendLog('Icon saved'); }; r.readAsDataURL(f); });
$('removeIcon').onclick = ()=>{ DB.icon = null; saveDB(); $('iconPreview').src=''; $('iconInfo').textContent='No icon'; };
function refreshTokenUI(){ const list = $('tokenList'); list.innerHTML=''; const sel = $('selectToken'); sel.innerHTML='<option value="">--é¸æŠ--</option>'; Object.entries(DB.tokens||{}).forEach(([id,t])=>{ const div = document.createElement('div'); div.className='item'; div.innerHTML = `<div><strong>${escapeHtml(t.label||id)}</strong><div class="small">â€¢â€¢â€¢â€¢${t.token?t.token.slice(-6):'(empty)'}</div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useBtn small">é¸æŠ</button><button data-id="${id}" class="delBtn small danger">å‰Šé™¤</button></div>`; list.appendChild(div); const opt = document.createElement('option'); opt.value = id; opt.textContent = t.label||id; sel.appendChild(opt); }); Array.from(document.getElementsByClassName('useBtn')).forEach(b=> b.onclick = ()=> { $('selectToken').value = b.dataset.id; b.parentElement.parentElement.style.backgroundColor = 'rgba(255,255,255,0.08)'; setTimeout(()=>b.parentElement.parentElement.style.backgroundColor = 'var(--card)', 300); } ); Array.from(document.getElementsByClassName('delBtn')).forEach(b=> b.onclick = ()=> { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.tokens[b.dataset.id]; saveDB(); refreshTokenUI(); } }); }
$('saveToken').onclick = ()=>{ const lbl = $('tokenLabel').value.trim(); const tok = $('tokenValue').value.trim(); if(!lbl||!tok){ alert('label ã¨ token ã‚’å…¥åŠ›'); return; } const id = 't_'+Date.now(); DB.tokens = DB.tokens || {}; DB.tokens[id] = {label:lbl, token:tok}; saveDB(); refreshTokenUI(); $('tokenLabel').value=''; $('tokenValue').value=''; };
$('clearTokens').onclick = ()=>{ if(confirm('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ DB.tokens={}; saveDB(); refreshTokenUI(); } };
function refreshTplUI(){ const out = $('groupList'); out.innerHTML=''; Object.entries(DB.templates||{}).forEach(([id,t])=>{ const div = document.createElement('div'); div.className='item'; div.innerHTML = `<div style="display:flex;gap:8px;align-items:center">${t.icon? `<img src="${t.icon}" class="img-preview" />` : `<div class="img-preview" style="background:var(--block);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:10px">no</div>`}<div><strong>${escapeHtml(t.label||id)}</strong><div class="small">${escapeHtml(t.name||'')} â†’ ${escapeHtml((t.users||[]).slice(0,2).join(','))}${(t.users||[]).length>2?'...':''}</div></div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useTpl small ok">åˆ©ç”¨</button><button data-id="${id}" class="fillTpl small ghost">Fill</button><button data-id="${id}" class="delTpl small danger">âœ–</button></div>`; out.appendChild(div); }); Array.from(document.getElementsByClassName('useTpl')).forEach(b=> b.onclick = ()=> applyTemplateToExec(b.dataset.id) ); Array.from(document.getElementsByClassName('fillTpl')).forEach(b=> b.onclick = ()=> fillTplForm(b.dataset.id) ); Array.from(document.getElementsByClassName('delTpl')).forEach(b=> b.onclick = ()=> { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.templates[b.dataset.id]; saveDB(); refreshTplUI(); } }); }
$('saveGroup').onclick = ()=>{ const lbl = $('gLabel').value.trim(); const name = $('gName').value.trim(); const users = $('gUsers').value.split(',').map(s=>s.trim()).filter(Boolean); const count = parseInt($('gCount').value)||1; if(!lbl||users.length<2){ alert('Label ã¨ user ã‚’(2äººä»¥ä¸Š)å…¥åŠ›'); return; } const id = 'tpl_'+Date.now(); DB.templates = DB.templates || {}; DB.templates[id] = {label:lbl, name:name, users:users, count:count, icon: DB.icon || null}; saveDB(); refreshTplUI(); $('gLabel').value=''; $('gName').value=''; $('gUsers').value=''; $('gCount').value='1'; alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ'); };
$('refreshGroups').onclick = refreshTplUI;
function applyTemplateToExec(id){ const t = DB.templates[id]; if(!t) return; $('exec_recipients').value = (t.users||[]).join(','); $('exec_name').value = t.name||''; $('exec_count').value = t.count||1; if(t.icon){ DB.icon = t.icon; saveDB(); $('iconPreview').src = DB.icon; $('iconInfo').textContent='Icon loaded'; } switchTabs('tabExec'); alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ Execute ç”»é¢ã«é©ç”¨ã—ã¾ã—ãŸ'); }
function fillTplForm(id){ const t = DB.templates[id]; if(!t) return; $('gLabel').value = t.label||''; $('gName').value = t.name||''; $('gUsers').value = (t.users||[]).join(','); $('gCount').value = t.count||1; }
function refreshSeqList(){ const out = $('seqList'); out.innerHTML=''; Object.entries(DB.sequences||{}).forEach(([id,s])=>{ const div = document.createElement('div'); div.className='item'; div.innerHTML = `<div><strong>${escapeHtml(s.name||id)}</strong><div class="small">${(s.blocks||[]).length} blocks</div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useSeq small">èª­ã¿è¾¼ã¿</button><button data-id="${id}" class="runSeqNow small ok">å®Ÿè¡Œ</button><button data-id="${id}" class="delSeq small danger">âœ–</button></div>`; out.appendChild(div); }); Array.from(document.getElementsByClassName('useSeq')).forEach(b=> b.onclick = ()=> { loadSequenceIntoWorkspace(b.dataset.id); switchTabs('tabScratch'); } ); Array.from(document.getElementsByClassName('runSeqNow')).forEach(b=> b.onclick = ()=> { loadSequenceIntoWorkspace(b.dataset.id); switchTabs('tabScratch'); setTimeout(()=> $('runSeq').click(), 120); } ); Array.from(document.getElementsByClassName('delSeq')).forEach(b=> b.onclick = ()=> { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.sequences[b.dataset.id]; saveDB(); refreshSeqList(); } }); }
$('saveSeq').onclick = ()=>{ const name = $('seqName').value.trim(); if(!name){ alert('Sequence name ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; } const data = workspaceToSequence(); if(data.length === 0){ alert('ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“'); return; } const id = 'seq_'+Date.now(); DB.sequences = DB.sequences || {}; DB.sequences[id] = {name:name, blocks:data}; saveDB(); refreshSeqList(); $('seqName').value=''; alert('ä¿å­˜ã—ã¾ã—ãŸ'); switchSideTab('tabSideSequences'); };
const workspace = $('workspace');
let blockCounter = 0;
function defaultBlockForType(type){ if(type==='api') return {type:'api', props:{method:'POST', path:'/channels/{{channel_id}}/messages', body:{content:"hello"}, headers:{}, extract:null}}; if(type==='wait') return {type:'wait', props:{sec:1}}; if(type==='loop') return {type:'loop', props:{count:2, blocks:[]}}; if(type==='cond') return {type:'cond', props:{code:200, blocks:[], variable:'status', value:200}}; if(type==='comment') return {type:'comment', props:{text:'note'}}; return {type:type, props:{}}; }
function summaryForBlock(obj){ if(!obj) return ''; if(obj.type==='api') return `${obj.props.method||'GET'} ${obj.props.path||'/users/@me'}${obj.props.extract ? ` (extract: ${obj.props.extract.var})` : ''}`; if(obj.type==='wait') return `wait ${obj.props.sec||1}s`; if(obj.type==='loop') return `loop ${obj.props.count||1}x`; if(obj.type==='cond'){ if(obj.props.variable === 'status') return `if status == ${obj.props.value || obj.props.code||200}`; return `if {{${obj.props.variable}}} == ${obj.props.value !== undefined ? obj.props.value : ''}`; } if(obj.type==='comment') return obj.props.text||''; return ''; }
function makeWBlock(obj){ const id = 'b_'+(++blockCounter); obj._id = id; const el = document.createElement('div'); el.className='wblock'; el.draggable = true; el.dataset.id = id; el.innerHTML = `<div><div class="meta">${escapeHtml(obj.type.toUpperCase())}</div><div class="small">${escapeHtml(summaryForBlock(obj))}</div></div><div class="btns"><button class="small ghost editBtn">âœ</button><button class="small ghost upBtn">â–²</button><button class="small ghost downBtn">â–¼</button><button class="small danger delBtn">âœ–</button></div>`; el._data = obj; el.addEventListener('dragstart', (e)=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', 'workspace:'+id); }); el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); }); el.addEventListener('click', (e)=> { e.stopPropagation(); selectBlock(el); } ); el.querySelector('.editBtn').onclick = (ev)=>{ ev.stopPropagation(); openBlockConfig(el); }; el.querySelector('.delBtn').onclick = (ev)=>{ ev.stopPropagation(); if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ el.remove(); refreshSeqPreview(); } }; el.querySelector('.upBtn').onclick = (ev)=>{ ev.stopPropagation(); const p = el.previousElementSibling; if(p) el.parentNode.insertBefore(el, p); refreshSeqPreview(); }; el.querySelector('.downBtn').onclick = (ev)=>{ ev.stopPropagation(); const n = el.nextElementSibling; if(n) el.parentNode.insertBefore(n, el); refreshSeqPreview(); }; return el; }
Array.from(document.getElementsByClassName('block')).forEach((b, idx)=>{ const t = b.dataset.type || ['api','wait','loop','cond','comment'][idx]; b.dataset.type = t; b.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', 'palette:'+t); b.classList.add('dragging'); }); b.addEventListener('dragend', ()=> b.classList.remove('dragging')); b.addEventListener('dblclick', ()=> { const el = makeWBlock(defaultBlockForType(t)); workspace.appendChild(el); refreshSeqPreview(); selectBlock(el); }); });
workspace.addEventListener('drop', (e)=>{ e.preventDefault(); const d = e.dataTransfer.getData('text/plain'); const afterElement = getDragAfterElement(workspace, e.clientX, e.clientY); if(!d) return; if(d.startsWith('palette:')){ const type = d.split(':')[1]; const obj = defaultBlockForType(type); const w = makeWBlock(obj); if(afterElement) workspace.insertBefore(w, afterElement); else workspace.appendChild(w); selectBlock(w); refreshSeqPreview(); } else if(d.startsWith('workspace:')){ const id = d.split(':')[1]; const draggedElement = document.querySelector(`.wblock[data-id="${id}"]`); if(draggedElement){ if(afterElement) workspace.insertBefore(draggedElement, afterElement); else workspace.appendChild(draggedElement); } refreshSeqPreview(); } });
workspace.addEventListener('dragover', e=> e.preventDefault());
function getDragAfterElement(container, x, y){ 
    const isVertical = container.classList.contains('vertical');
    const draggableElements = [...container.querySelectorAll('.wblock:not(.dragging)')]; 
    return draggableElements.reduce((closest, child)=>{ 
        const rect = child.getBoundingClientRect(); 
        const offset = isVertical ? y - rect.top - child.offsetHeight/2 : x - rect.left - child.offsetWidth/2; 
        if(offset < 0 && offset > closest.offset){ 
            return {offset:offset, element:child}; 
        }else{ 
            return closest; 
        } 
    }, {offset: -Infinity}).element; 
}
function selectBlock(el){ Array.from(workspace.children).forEach(c=> c.style.boxShadow='none'); el.style.boxShadow = '0 0 0 2px var(--accent-light)'; openBlockConfig(el); }
function openBlockConfig(el){ switchSideTab('tabSideLogsConfig'); const cfg = $('blockConfig'); $('blockConfigWrap').style.display = 'block'; cfg.innerHTML = ''; const obj = el._data; if(obj.type==='api'){ cfg.innerHTML = `<label>Method (GET/POST/..)</label><input id="cfg_method" type="text" value="${escapeHtml(obj.props.method||'GET')}" /><label>Path ({{var}} ã‚’åˆ©ç”¨å¯)</label><input id="cfg_path" type="text" value="${escapeHtml(obj.props.path||'/users/@me')}" /><label>Body (JSON, {{var}} ã‚’åˆ©ç”¨å¯)</label><textarea id="cfg_body" style="min-height:60px">${obj.props.body?escapeHtml(JSON.stringify(obj.props.body,null,2)):''}</textarea><label>Headers (JSON)</label><textarea id="cfg_headers" style="min-height:60px">${obj.props.headers?escapeHtml(JSON.stringify(obj.props.headers,null,2)):''}</textarea><div class="title" style="margin-top:10px">Extract Value</div><label>Save to variable (ä¾‹: channel_id)</label><input id="cfg_extract_var" type="text" value="${escapeHtml(obj.props.extract?.var||'')}" placeholder="å¤‰æ•°å" /><label>JSONPath (ä¾‹: .id, .messages[0].id)</label><input id="cfg_extract_path" type="text" value="${escapeHtml(obj.props.extract?.path||'')}" placeholder=".id" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; } else if(obj.type==='wait'){ cfg.innerHTML = `<label>Seconds</label><input id="cfg_sec" type="text" value="${escapeHtml(String(obj.props.sec||1))}" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; } else if(obj.type==='loop'){ cfg.innerHTML = `<label>Count</label><input id="cfg_count" type="text" value="${escapeHtml(String(obj.props.count||1))}" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; } else if(obj.type==='cond'){ cfg.innerHTML = `<label>Condition Target</label><select id="cfg_target"><option value="status" ${obj.props.variable === 'status' ? 'selected' : ''}>Status Code (ç›´å‰ã®API)</option><option value="variable" ${obj.props.variable !== 'status' ? 'selected' : ''}>Variable ({{var}})</option></select><div id="cfg_var_wrap" style="display:${obj.props.variable !== 'status' ? 'block' : 'none'}"><label>Variable Name ({{var}})</label><input id="cfg_variable" type="text" value="${escapeHtml(obj.props.variable !== 'status' ? (obj.props.variable || '') : '')}" /></div><label>Operator: == </label><label>Value</label><input id="cfg_value" type="text" value="${escapeHtml(String(obj.props.value !== undefined ? obj.props.value : (obj.props.code || 200)))}" /><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; $('cfg_target').onchange = (e)=>{ if(e.target.value === 'variable') $('cfg_var_wrap').style.display = 'block'; else $('cfg_var_wrap').style.display = 'none'; }; } else if(obj.type==='comment'){ cfg.innerHTML = `<label>Text</label><textarea id="cfg_text">${escapeHtml(obj.props.text||'')}</textarea><div class="controls"><button id="cfgSave" class="small ok">ä¿å­˜</button></div>`; } $('cfgSave').onclick = ()=>{ try{ if(obj.type==='api'){ const btxt = $('cfg_body').value.trim(); obj.props.body = btxt? JSON.parse(btxt) : null; const htxt = $('cfg_headers').value.trim(); obj.props.headers = htxt? JSON.parse(htxt) : {}; obj.props.method = $('cfg_method').value.trim().toUpperCase()||'GET'; obj.props.path = $('cfg_path').value.trim()||'/users/@me'; const ext_var = $('cfg_extract_var').value.trim(); const ext_path = $('cfg_extract_path').value.trim(); if(ext_var && ext_path) obj.props.extract = {var:ext_var, path:ext_path}; else obj.props.extract = null; } else if(obj.type==='wait'){ obj.props.sec = Number($('cfg_sec').value)||1; } else if(obj.type==='loop'){ obj.props.count = Number($('cfg_count').value)||1; } else if(obj.type==='cond'){ const target = $('cfg_target').value; obj.props.variable = target === 'status' ? 'status' : $('cfg_variable').value.trim(); if(target === 'status') obj.props.code = Number($('cfg_value').value) || 200; else { obj.props.code = undefined; obj.props.value = $('cfg_value').value; } } else if(obj.type==='comment'){ obj.props.text = $('cfg_text').value||''; } }catch(e){ alert('JSON parse error'); return; } el.querySelector('.meta').textContent = obj.type.toUpperCase(); el.querySelector('.small').textContent = summaryForBlock(obj); refreshSeqPreview(); }; }
function workspaceToSequence(){ return Array.from(workspace.children).map(c=> c._data ? JSON.parse(JSON.stringify(c._data)) : null).filter(Boolean); }
function loadSequenceObjectToWorkspace(blocks){ workspace.innerHTML=''; blockCounter=0; if(!Array.isArray(blocks)) return; for(const b of blocks){ const el = makeWBlock(b); workspace.appendChild(el); } refreshSeqPreview(); }
function loadSequenceIntoWorkspace(id){ const s = DB.sequences[id]; if(!s){ alert('sequence not found'); return; } loadSequenceObjectToWorkspace(s.blocks||[]); }
function refreshSeqPreview(){ $('seqPreview').textContent = JSON.stringify(workspaceToSequence(), null, 2); }
$('clearWorkspace').onclick = ()=>{ if(confirm('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')){ loadSequenceObjectToWorkspace([]); } };
let runStopFlag = false;
$('btnStop').onclick = ()=>{ runStopFlag = true; $('btnStop').style.display='none'; appendLog('åœæ­¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã¾ã—ãŸ'); };
function sleepMs(ms){ return new Promise(r=>setTimeout(r, ms)); }
async function fetchWithRetry(url, opts){ while(true){ if(runStopFlag) throw new Error('Stopped by user'); const res = await fetch(url, opts); if(res.status !== 429) return res; let retry = 1; try{ const j = await res.json().catch(()=>null); retry = j && j.retry_after ? j.retry_after : (parseFloat(res.headers.get('Retry-After')) || 1); }catch(e){} appendLog(`429 ãƒ¬ãƒ¼ãƒˆåˆ¶é™: ${retry}s å¾…æ©Ÿ`); let left = Math.ceil(retry); while(left>0){ if(runStopFlag) throw new Error('Stopped by user'); await sleepMs(1000); left--; } } }
window._scratch_context = {};
function refreshContextView() { $('contextView').textContent = JSON.stringify(window._scratch_context, null, 2); }
function injectVariables(s, context) {
Â  Â  if (!s) return s;
Â  Â  return String(s).replace(/\{\{(\w+)\}\}/g, (match, p1) => context[p1] !== undefined ? context[p1] : match);
}
function extractValue(json, path) {
Â  Â  if (!json || !path) return undefined;
Â  Â  try {
Â  Â  Â  Â  if (path.startsWith('.')) path = path.slice(1);
Â  Â  Â  Â  const parts = path.split('.');
Â  Â  Â  Â  let current = json;
Â  Â  Â  Â  for (const part of parts) {
Â  Â  Â  Â  Â  Â  const arrayMatch = part.match(/(\w+)\[(\d+)\]/);
Â  Â  Â  Â  Â  Â  if (arrayMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  const key = arrayMatch[1];
Â  Â  Â  Â  Â  Â  Â  Â  const index = parseInt(arrayMatch[2]);
Â  Â  Â  Â  Â  Â  Â  Â  current = current[key];
Â  Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(current) || index >= current.length) return undefined;
Â  Â  Â  Â  Â  Â  Â  Â  current = current[index];
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  current = current[part];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (current === undefined || current === null) return undefined;
Â  Â  Â  Â  }
Â  Â  Â  Â  return current;
Â  Â  } catch (e) {
Â  Â  Â  Â  return undefined;
Â  Â  }
}
function compareValues(a, b, isNumeric) {
Â  Â  if (isNumeric) return Number(a) === Number(b);
Â  Â  return String(a) === String(b);
}
async function runSequence(arr,token){
Â  Â  for(let i=0;i<arr.length;i++){
Â  Â  Â  Â  if(runStopFlag){appendLog('å®Ÿè¡Œä¸­æ­¢');return;}
Â  Â  Â  Â  const b=arr[i];
Â  Â  Â  Â  appendLog(`-> [${i+1}/${arr.length}] ${b.type} ${summaryForBlock(b)}`);
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='comment'){
Â  Â  Â  Â  Â  Â  if(b.props&&b.props.text)appendLog(`COMMENT: ${b.props.text}`);
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='wait'){
Â  Â  Â  Â  Â  Â  const t=Number(b.props&&b.props.sec)||1;
Â  Â  Â  Â  Â  Â  appendLog(`WAIT ${t}s`);
Â  Â  Â  Â  Â  Â  await sleepMs(t*1000);
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='loop'){
Â  Â  Â  Â  Â  Â  const cnt=Number(b.props&&b.props.count)||1;
Â  Â  Â  Â  Â  Â  const next=arr[i+1];
Â  Â  Â  Â  Â  Â  if(!next){appendLog('LOOP: no next block');continue;}
Â  Â  Â  Â  Â  Â  appendLog(`LOOP x${cnt} -> ${summaryForBlock(next)}`);
Â  Â  Â  Â  Â  Â  for(let k=0;k<cnt;k++){
Â  Â  Â  Â  Â  Â  Â  Â  if(runStopFlag)return;
Â  Â  Â  Â  Â  Â  Â  Â  window._scratch_context.loop_index = k + 1;
Â  Â  Â  Â  Â  Â  Â  Â  await runSequence([next],token);
Â  Â  Â  Â  Â  Â  Â  Â  refreshContextView();
Â  Â  Â  Â  Â  Â  }
            delete window._scratch_context.loop_index;
Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='cond'){
Â  Â  Â  Â  Â  Â  const targetVar = b.props.variable || 'status';
Â  Â  Â  Â  Â  Â  const valueToCompare = b.props.value !== undefined ? b.props.value : b.props.code;
Â  Â  Â  Â  Â  Â  let actualValue;

Â  Â  Â  Â  Â  Â  if (targetVar === 'status') {
Â  Â  Â  Â  Â  Â  Â  Â  actualValue = window._scratch_last_status || 0;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  actualValue = window._scratch_context[targetVar];
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const isNumeric = !isNaN(Number(actualValue)) && !isNaN(Number(valueToCompare));
Â  Â  Â  Â  Â  Â  const conditionMet = compareValues(actualValue, valueToCompare, isNumeric);

Â  Â  Â  Â  Â  Â  appendLog(`COND check {{${targetVar}}}(${actualValue}) == ${valueToCompare}`);

Â  Â  Â  Â  Â  Â  if(conditionMet && Array.isArray(b.props.blocks)) {
Â  Â  Â  Â  Â  Â  Â  Â  await runSequence(b.props.blocks,token);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  appendLog('COND skipped');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(b.type==='api'){
Â  Â  Â  Â  Â  Â  let method=(b.props.method||'GET').toUpperCase();
Â  Â  Â  Â  Â  Â  let path=injectVariables(b.props.path||'/users/@me', window._scratch_context);
Â  Â  Â  Â  Â  Â  let body=b.props.body!==undefined?b.props.body:null;
Â  Â  Â  Â  Â  Â  let headers=Object.assign({},b.props.headers||{});
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (body && typeof body === 'object') {
Â  Â  Â  Â  Â  Â  Â  Â  let bodyStr = JSON.stringify(body);
Â  Â  Â  Â  Â  Â  Â  Â  bodyStr = injectVariables(bodyStr, window._scratch_context);
Â  Â  Â  Â  Â  Â  Â  Â  try { body = JSON.parse(bodyStr); } catch(e) { appendLog('API ERROR: Body variable injection failed'); body = null; }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const opts={method,headers:Object.assign({'Authorization':token,'Content-Type':'application/json'},headers)};
Â  Â  Â  Â  Â  Â  if(body!==null&&['POST','PATCH','PUT','PUT','DELETE'].includes(method))opts.body=JSON.stringify(body);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const url='https://discord.com/api/v9'+path;
Â  Â  Â  Â  Â  Â  appendLog(`API ${method} ${path}`);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let resJson = null;

Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  const res=await fetchWithRetry(url,opts);
Â  Â  Â  Â  Â  Â  Â  Â  const txt=await res.text().catch(()=>null);
Â  Â  Â  Â  Â  Â  Â  Â  window._scratch_last_status=res.status;
Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[API res] ${res.status} ${txt?(txt.length>400?txt.slice(0,400)+'...':txt):''}`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (txt && res.headers.get('content-type') && res.headers.get('content-type').includes('application/json')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { resJson = JSON.parse(txt); } catch(e) { resJson = null; }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  Â  Â  Â  appendLog('API ERROR: '+e.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (b.props.extract && resJson) {
Â  Â  Â  Â  Â  Â  Â  Â  const extracted = extractValue(resJson, b.props.extract.path);
Â  Â  Â  Â  Â  Â  Â  Â  if (extracted !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window._scratch_context[b.props.extract.var] = extracted;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`EXTRACTED: ${b.props.extract.var} = ${extracted}`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`EXTRACT FAIL: Path ${b.props.extract.path} not found`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  refreshContextView();

Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  }
Â  Â  Â  Â  appendLog('Unknown block type: '+b.type);
Â  Â  }
}
$('btnExec').onclick = async ()=>{ if(!$('consentExec').checked){ alert('å®Ÿè¡Œå‰ã«åŒæ„ã—ã¦ãã ã•ã„'); return; } const sel = $('selectToken').value; if(!sel){ alert('Token ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } const token = DB.tokens[sel].token; const rec = $('exec_recipients').value.split(',').map(s=>s.trim()).filter(Boolean); if(rec.length < 2){ alert('Recipients ã¯2äººä»¥ä¸Šå¿…è¦ã§ã™'); return; } const name = $('exec_name').value.trim(); const count = Number($('exec_count').value) || 1; runStopFlag = false; $('btnStop').style.display='inline-block'; appendLog('é–‹å§‹: Create Group x'+count); for(let i=0;i<count;i++){ if(runStopFlag) break; try{ const res = await fetchWithRetry('https://discord.com/api/v9/users/@me/channels', { method:'POST', headers:{'Authorization':token,'Content-Type':'application/json'}, body: JSON.stringify({recipients:rec}) }); const jtxt = await res.text().catch(()=>null); appendLog(`[Create ${i+1}] ${res.status} ${jtxt? (jtxt.length>400? jtxt.slice(0,400)+'...': jtxt):''}`); window._scratch_last_status = res.status; if(res.ok && name){ let j = null; try{ j = JSON.parse(jtxt); }catch(e){} if(j && j.id){ const cid = j.id; const patchBody = {name: name + (count>1 ? `_${i+1}` : '')}; if(DB.icon) patchBody.icon = DB.icon; const pres = await fetchWithRetry('https://discord.com/api/v9/channels/'+cid, { method:'PATCH', headers:{'Authorization':token,'Content-Type':'application/json'}, body: JSON.stringify(patchBody) }); const ptxt = await pres.text().catch(()=>null); appendLog(`[PATCH ${cid}] ${pres.status} ${ptxt?ptxt.slice(0,400):''}`); window._scratch_last_status = pres.status; } else appendLog('channel id ãŒè¿”ã‚‰ãš name ã‚’ PATCH ã§ãã¾ã›ã‚“ã§ã—ãŸ'); } }catch(e){ appendLog('ERROR create: '+e.message); } } $('btnStop').style.display='none'; runStopFlag = false; appendLog('å®Œäº†'); };
$('runSeq').onclick = async ()=>{ const sel = $('selectToken').value; if(!sel){ alert('Token ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } if(!confirm('Sequence ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿï¼ˆè‡ªå·±è²¬ä»»ï¼‰')) return; const token = DB.tokens[sel].token; window._scratch_context = {}; runStopFlag = false; $('btnStop').style.display='inline-block'; $('scratchLog').textContent = ''; try{ const seq = workspaceToSequence(); await runSequence(seq, token); }catch(e){ appendLog('å®Ÿè¡Œä¸­æ–­: '+(e && e.message ? e.message : String(e))); } $('btnStop').style.display='none'; runStopFlag=false; appendLog('Sequence å®Ÿè¡Œçµ‚äº†'); refreshContextView(); };
// Tab Switching (Main Tabs)
function switchTabs(targetId){
    const mainTabs = ['tabExec', 'tabScratch'];
    const views = ['viewExec', 'viewScratch'];
    
    mainTabs.forEach(id => {
        const btn = $(id);
        const view = $(views[mainTabs.indexOf(id)]);
        if (id === targetId) {
            btn.classList.add('active');
            view.style.display = 'block';
            if (id === 'tabScratch') {
                switchSideTab('tabSideLogsConfig');
                refreshContextView();
            } else {
                $('blockConfigWrap').style.display = 'none';
            }
        } else {
            btn.classList.remove('active');
            view.style.display = 'none';
        }
    });
}
$('tabExec').onclick = ()=> switchTabs('tabExec');
$('tabScratch').onclick = ()=> switchTabs('tabScratch');

// Tab Switching (Side Tabs)
function switchSideTab(targetId){
    const sideTabs = ['tabSideTemplates', 'tabSideSequences', 'tabSideLogsConfig'];
    const views = ['sideTemplates', 'sideSequences', 'sideLogConfig'];

    sideTabs.forEach(id => {
        const btn = $(id);
        const view = $(views[sideTabs.indexOf(id)]);
        if (id === targetId) {
            btn.classList.add('active');
            view.classList.add('active');
            if (id === 'tabSideLogsConfig' && $('viewScratch').style.display !== 'none') {
                $('scratchLogContainer').style.display = 'flex';
            } else {
                $('scratchLogContainer').style.display = 'none';
            }
        } else {
            btn.classList.remove('active');
            view.classList.remove('active');
        }
    });
    // Logs/Configã‚¿ãƒ–ã§ã¯ãªã„å ´åˆã€ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šã¯éè¡¨ç¤º
    if (targetId !== 'tabSideLogsConfig') {
        $('blockConfigWrap').style.display = 'none';
    } else {
        // Logs/Configã‚¿ãƒ–ã ãŒã€rawAPIãƒ“ãƒ¥ãƒ¼ã§ã¯ãªã„å ´åˆã€Logã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
        if ($('viewScratch').style.display === 'none') {
            $('scratchLogContainer').style.display = 'none';
        }
    }
}
$('tabSideTemplates').onclick = ()=> switchSideTab('tabSideTemplates');
$('tabSideSequences').onclick = ()=> switchSideTab('tabSideSequences');
$('tabSideLogsConfig').onclick = ()=> switchSideTab('tabSideLogsConfig');


// Layout Toggling
$('toggleLayout').onclick = ()=>{ 
    const isVertical = $('workspace').classList.toggle('vertical');
    alert(isVertical ? 'ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç¸¦è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ' : 'ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ¨ªè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
};

$('exportSeq').onclick = ()=>{ const data = workspaceToSequence(); const text = JSON.stringify({exported:Date.now(), blocks:data}, null, 2); const blob = new Blob([text], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'sequence.json'; a.click(); URL.revokeObjectURL(url); };
$('importSeq').onclick = ()=>{ const f = document.createElement('input'); f.type='file'; f.accept='application/json'; f.onchange = ()=> { const file = f.files[0]; if(!file) return; const r = new FileReader(); r.onload = ()=> { try{ const j = JSON.parse(r.result); if(j.blocks && Array.isArray(j.blocks)) { loadSequenceObjectToWorkspace(j.blocks); alert('èª­ã¿è¾¼ã¿å®Œäº†'); switchTabs('tabScratch'); } else alert('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«'); }catch(e){ alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'); } }; r.readAsText(file); }; f.click(); };
$('exportAll').onclick = ()=>{ const text = JSON.stringify({exported:Date.now(), db:DB}, null, 2); const blob = new Blob([text], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'gtools_full_export.json'; a.click(); URL.revokeObjectURL(url); };
$('importAll').onclick = ()=>{ const f = document.createElement('input'); f.type='file'; f.accept='application/json'; f.onchange = ()=> { const file = f.files[0]; if(!file) return; const r = new FileReader(); r.onload = ()=> { try{ const j = JSON.parse(r.result); if(j.db){ DB = j.db; saveDB(); alert('å…¨è¨­å®šã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ'); } else alert('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«'); }catch(e){ alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'); } }; r.readAsText(file); }; f.click(); };
$('btnGen').onclick = ()=>{ const sel = $('selectToken').value; if(!sel){ alert('Token ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } const token = DB.tokens[sel].token; const rec = $('exec_recipients').value.split(',').map(s=>s.trim()).filter(Boolean); if(rec.length < 2){ alert('Recipients ã¯2äººä»¥ä¸Šå¿…è¦ã§ã™'); return; } const jsonBody = JSON.stringify({recipients:rec}, null, 2); const curl = `curl -X POST "https://discord.com/api/v9/users/@me/channels" \\\n-H "Authorization: ${token}" \\\n-H "Content-Type: application/json" \\\n-d '${jsonBody.replace(/'/g, "\\'")}'`; const fetchCode = `fetch('https://discord.com/api/v9/users/@me/channels', {\nÂ  method: 'POST',\nÂ  headers: {\nÂ  Â  'Authorization': '${token}',\nÂ  Â  'Content-Type': 'application/json'\nÂ  },\nÂ  body: JSON.stringify({recipients: ${JSON.stringify(rec)}})\n})`; $('execLog').textContent = `[curl]\n${curl}\n\n[fetch]\n${fetchCode}`; };
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function loadInitial(){ 
    if(DB.icon){ $('iconPreview').src = DB.icon; $('iconInfo').textContent = 'Icon loaded'; } else { $('iconPreview').src = ''; $('iconInfo').textContent = 'No icon'; } 
    refreshTokenUI(); refreshTplUI(); refreshSeqList(); 
    
    // åˆæœŸè¡¨ç¤ºã¯Executeã¨Templatesã‚¿ãƒ–
    switchTabs('tabExec');
    switchSideTab('tabSideTemplates');
}
window.onload = loadInitial;
// ... [END of JavaScript block] ...
</script>
</body>
</html>
