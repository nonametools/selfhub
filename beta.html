<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Group Tools â€” API Execute (V4: White Theme, Enhanced Loop)</title>
<style>
:root{
Â  --bg: #f5f7fa;
Â  --card: #ffffff;
Â  --accent: #1f6feb;
Â  --accent-dark: #104191;
Â  --accent-light: #4c8fff;
Â  --muted: #6c757d;
Â  --text-primary: #212529;
Â  --ok: #28a745;
Â  --err: #dc3545;
Â  --block: #e9ecef;
Â  --block-contrast: #dee2e6;
Â  --border: #dee2e6;
Â  --border-strong: #ced4da;
Â  --shadow: 0 4px 12px rgba(0,0,0,0.08);
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text-primary);overflow:hidden;}
header{
Â  Â  display:flex;justify-content:space-between;align-items:center;padding:12px 20px;
Â  Â  border-bottom:1px solid var(--border-strong);background:var(--card);flex-shrink:0;
Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
h1{margin:0;font-size:22px;color:var(--text-primary)}
.sub{font-size:14px;color:var(--muted)}

.main-layout{
Â  Â  display: flex;
Â  Â  height: calc(100vh - 68px);
Â  Â  padding: 16px;
Â  Â  gap: 16px;
Â  Â  overflow: hidden;
}
.col-info {
Â  Â  width: 220px;
Â  Â  flex-shrink: 0;
}
.col-main {
Â  Â  flex-grow: 1;
Â  Â  min-width: 500px;
Â  Â  display: flex;
Â  Â  flex-direction: column;
}
.col-side {
Â  Â  width: 350px;
Â  Â  flex-shrink: 0;
}

.card{
Â  Â  background:var(--card);
Â  Â  padding:16px;
Â  Â  border-radius:12px;
Â  Â  border:1px solid var(--border);
Â  Â  box-shadow:var(--shadow);
Â  Â  height: 100%;
Â  Â  box-sizing: border-box;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  overflow: hidden;
}

.main-tabs{ display:flex; margin-bottom:16px; border-bottom:1px solid var(--border-strong); }
.main-tabs button {
Â  Â  padding: 10px 15px; border: none; background: transparent; color: var(--muted);
Â  Â  font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent;
Â  Â  transition: color 0.2s, border-bottom-color 0.2s;
}
.main-tabs button.active {
Â  Â  color: var(--accent); border-bottom-color: var(--accent);
}
#mainContentView {
Â  Â  flex-grow: 1;
Â  Â  overflow-y: auto;
Â  Â  padding: 0 16px 16px 16px;
}
#viewExec, #viewScratch { height: 100%; box-sizing: border-box; }

label{display:block;font-size:13px;color:var(--text-primary);font-weight:600;margin-top:10px}
input[type=text], input[type=password], textarea, select{
Â  Â  width:100%;padding:8px;border-radius:6px;border:1px solid var(--border-strong);
Â  Â  background:var(--block);color:var(--text-primary);box-sizing:border-box;
Â  Â  transition:border-color 0.2s;font-size:14px;
}
input:focus, textarea:focus, select:focus {outline:none;border-color:var(--accent);background:#ffffff}
textarea{min-height:60px;resize:vertical}
.row{display:flex;gap:8px;align-items:center}
button{
Â  Â  padding:8px 12px;border-radius:6px;border:none;background:var(--accent);
Â  Â  color:white;cursor:pointer;font-weight:600;transition:background 0.2s;
}
button:hover{background:var(--accent-dark)}
button.ghost{background:transparent;border:1px solid var(--muted);color:var(--muted)}
button.ghost:hover{background:var(--block-contrast);color:var(--accent);border-color:var(--accent)}
button.small{padding:6px 10px;font-size:13px}
.danger{background:var(--err)}
.danger:hover{background:#c0303f}
.ok{background:var(--ok)}
.ok:hover{background:#218838}
.muted{color:var(--muted);font-size:12px}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.title{font-weight:700;color:var(--text-primary);margin-bottom:8px;font-size:16px}
.pill{
Â  Â  display:inline-block;padding:4px 8px;border-radius:8px;
Â  Â  background:var(--accent);font-size:13px;color:white;font-weight:600;
}

#headerControls {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 15px;
Â  Â  padding: 5px 0;
}
#headerControls select { width: 150px; }

.info-list {
Â  Â  margin-top: 10px;
Â  Â  overflow-y: auto;
Â  Â  flex-grow: 1;
}
.info-item {
Â  Â  padding: 10px;
Â  Â  border-radius: 6px;
Â  Â  margin-bottom: 6px;
Â  Â  cursor: pointer;
Â  Â  transition: background 0.2s;
Â  Â  border: 1px solid transparent;
}
.info-item:hover { background: var(--block-contrast); border-color: var(--border-strong); }
.info-item.active { background: var(--accent-light); color: white; border-color: var(--accent); }
.info-item.active strong { color: white; }
.info-item strong { font-size: 14px; color: var(--accent-dark); }
.info-item .small { font-size: 12px; }

.img-preview {
Â  Â  width: 30px;
Â  Â  height: 30px;
Â  Â  border-radius: 50%;
Â  Â  object-fit: cover;
Â  Â  flex-shrink: 0;
}
#execForm img {
Â  Â  margin-top: 10px;
Â  Â  border: 1px solid var(--border-strong);
}
.list-container .item .img-preview {
Â  Â  margin-top: 0;
}

#scratchArea {
Â  Â  display: grid;
Â  Â  grid-template-columns: 80px 1fr;
Â  Â  gap: 16px;
Â  Â  flex-grow: 1;
}
.palette {
Â  Â  overflow: hidden;
Â  Â  background: var(--block);
Â  Â  padding: 12px;
Â  Â  border-radius: 8px;
Â  Â  flex-shrink: 0;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: center;
}
.palette .block {
Â  Â  padding: 10px;
Â  Â  width: 100%;
Â  Â  text-align: center;
Â  Â  background: var(--accent);
Â  Â  color: white;
Â  Â  border-radius: 6px;
Â  Â  margin-bottom: 8px;
Â  Â  cursor: grab;
Â  Â  transition: background 0.2s;
Â  Â  font-size: 20px;
}
.palette .block[data-type^="loop"] {
Â  Â  background: #e3931c;
}
.palette .block:hover{background:var(--accent-dark)}
.palette .block[data-type^="loop"]:hover{background: #c77b0d;}

#workspace {
Â  Â  min-height: 300px;
Â  Â  border: 2px dashed var(--border-strong);
Â  Â  padding: 12px;
Â  Â  border-radius: 8px;
Â  Â  background: var(--block-contrast);
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 10px;
Â  Â  overflow-y: auto;
Â  Â  align-items: stretch;
}
.wblock{
Â  Â  background:var(--card);
Â  Â  padding:10px 15px;
Â  Â  border-radius:8px;
Â  Â  display:flex;
Â  Â  justify-content:space-between;
Â  Â  align-items:center;
Â  Â  cursor:grab;
Â  Â  border:1px solid var(--border);
Â  Â  box-shadow:0 0 0 0 transparent;
Â  Â  transition:box-shadow 0.1s, background 0.2s;
}
.wblock:hover{box-shadow:0 0 0 2px var(--accent-light)}
.wblock.selected{box-shadow:0 0 0 2px var(--accent) !important;}
.wblock .meta{font-size:15px;font-weight:700;color:var(--accent)}
.wblock[data-type^="loop"] .meta { color: #c77b0d; }
.wblock .summary{font-size:13px;color:var(--muted)}
.wblock .btns button { background: var(--block-contrast); color: var(--text-primary); border: 1px solid var(--border); }
.wblock .btns button:hover { background: var(--border); }
.wblock .btns .danger:hover { background: var(--err); color: white; }

.side-tabs {
Â  Â  display: flex;
Â  Â  border-bottom: 1px solid var(--border);
Â  Â  margin-bottom: 12px;
Â  Â  flex-shrink: 0;
}
.side-tabs button {
Â  Â  flex-grow: 1;
Â  Â  background: transparent;
Â  Â  color: var(--muted);
Â  Â  border-radius: 0;
Â  Â  border-bottom: 3px solid transparent;
}
.side-tabs button.active {
Â  Â  color: var(--accent);
Â  Â  border-bottom-color: var(--accent);
}

.config-container {
Â  Â  padding: 10px;
Â  Â  border-radius: 8px;
Â  Â  background: var(--block);
Â  Â  margin-top: 10px;
Â  Â  overflow-y: auto;
Â  Â  flex-shrink: 0;
}
pre{
Â  Â  background: #f8f9fa;
Â  Â  padding:12px;
Â  Â  border-radius:8px;
Â  Â  color:var(--text-primary);
Â  Â  overflow:auto;
Â  Â  white-space:pre-wrap;
Â  Â  border:1px solid var(--border-strong);
Â  Â  font-size:12px;
Â  Â  flex-grow: 1;
Â  Â  min-height: 150px;
}
#execLogContainer { margin-top: 15px; }

#execForm {
Â  Â  display: grid;
Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  gap: 20px;
}
#execForm > div:last-child { grid-column: 1 / -1; }


.list-container {
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 8px;
}
.list-container .item {
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  padding: 8px 10px;
Â  Â  border: 1px solid var(--border);
Â  Â  border-radius: 6px;
Â  Â  background: var(--card);
}
</style>
</head>
<body>
<header>
Â  <div>
Â  Â  <h1>Group Tools â€” Easy API</h1>
Â  Â  <div class="sub">ç›´æ„Ÿçš„ã§å…¥åŠ›ã®å°‘ãªã„æ“ä½œã‚’è¿½æ±‚</div>
Â  </div>
Â  <div id="headerControls">
Â  Â  <div class="row">
Â  Â  Â  Â  <span class="pill" style="background:var(--ok)">Token:</span>
Â  Â  Â  Â  <select id="selectToken"><option value="">--æœªé¸æŠ--</option></select>
Â  Â  </div>
Â  Â  <button id="tokenManagementBtn" class="small ghost">ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†</button>
Â  </div>
</header>

<div class="main-layout">
Â  Â  Â  <div class="col-info">
Â  Â  <div class="card">
Â  Â  Â  <div class="title">ğŸ“‹ Active API Information</div>
Â  Â  Â  <div id="infoList" class="info-list">
Â  Â  Â  Â  Â  <div class="info-item active"><strong>API / Task Select</strong><div class="small">Main task menu</div></div>
Â  Â  Â  Â  Â  <div class="info-item"><strong>Current Variables</strong><div class="small">last_id: 123...</div></div>
Â  Â  Â  Â  Â  <div class="info-item"><strong>Saved Templates</strong><div class="small">template_A, template_B</div></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  Â  <div class="col-main card" style="padding:0; overflow:hidden;">
Â  Â  Â  Â  <div class="main-tabs">
Â  Â  Â  Â  Â  Â  <button id="tabExec" class="active">ğŸ‘¥ Group Creation (ç°¡æ˜“å®Ÿè¡Œ)</button>
Â  Â  Â  Â  Â  Â  <button id="tabScratch">ğŸ› ï¸ Sequence Builder (é«˜åº¦ãªè‡ªå‹•åŒ–)</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="mainContentView">
Â  Â  Â  Â  Â  Â  <div id="viewExec" class="active-view">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="execForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title">Template Selection & Parameters</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>åˆ©ç”¨ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="exec_template_select"><option value="">--ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ--</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Recipients (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="exec_recipients" type="text" placeholder="æ‰‹å‹•å…¥åŠ›ã¾ãŸã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ãƒ­ãƒ¼ãƒ‰" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Optional Group Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="exec_name" type="text" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Count (ä½œæˆæ•°)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="exec_count" type="number" value="1" min="1" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="saveTemplate" class="small ok">ç¾åœ¨ã®è¨­å®šã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title">Preview & Confirmation</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="iconPreview" class="img-preview" alt="Icon" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="margin-top:0;">Group Icon</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="iconFile" type="file" accept="image/*" class="small" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="removeIcon" class="small ghost" style="margin-top:5px">ã‚¢ã‚¤ã‚³ãƒ³å‰Šé™¤</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="margin-top:15px"><input type="checkbox" id="consentExec" /> å®Ÿè¡Œãƒªã‚¹ã‚¯ã‚’ç†è§£ã—ã€åŒæ„ã—ã¾ã™</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnExec" class="ok" style="font-size:16px;">ğŸš€ å®Ÿè¡Œ (Create Groups)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="execLogContainer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title">å®Ÿè¡Œãƒ­ã‚° / APIãƒ¬ã‚¹ãƒãƒ³ã‚¹</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <pre id="execLog">â€”</pre>
Â  Â  Â  Â  Â  ã€€ã€€ã€€ã€€ã€€ã€€</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  <div id="viewScratch" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="scratchTopControls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="seqName" type="text" placeholder="Sequenceå" style="width:180px" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="saveSeq" class="small ok">Sequence ä¿å­˜</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="runSeq" class="ok">å®Ÿè¡Œ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="controls" style="margin:0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="clearWorkspace" class="ghost small">ã‚¯ãƒªã‚¢</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnStop" class="danger small" style="display:none">åœæ­¢</button>
Â  Â  Â  ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="scratchArea">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="palette">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title" style="font-size:14px; margin-top:0;">Blocks</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="api" title="API Call">ğŸ“¡</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="wait" title="Wait (Delay)">â±ï¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="loop_start" title="Loop Start">â–¶ï¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="loop_end" title="Loop End">â¹ï¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="cond" title="If Condition">â“</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="block" draggable="true" data-type="comment" title="Comment">ğŸ’¬</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="workspace" ondragover="event.preventDefault()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="muted" style="text-align:center; padding-top:50px">ã“ã“ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  </div>
Â  Â 
Â  Â  <div class="col-side card">
Â  Â  Â  Â  <div class="side-tabs">
Â  Â  Â  Â  Â  Â  <button id="tabSideTemplates" class="active">ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
Â  Â  Â  Â  Â  Â  <button id="tabSideSequences">âš™ï¸ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</button>
Â  Â  Â  Â  Â  Â  <button id="tabSideConfig">ğŸ’¡ ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š/ãƒ­ã‚°</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="side-content" style="flex-grow:1; overflow-y:auto; padding-top:5px;">
Â  Â  Â  Â  Â  Â  <div id="sideTemplates" class="active">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="title">ä¿å­˜æ¸ˆ Group Templates (ã‚¯ãƒªãƒƒã‚¯ã§åˆ©ç”¨)</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="groupList" class="list-container" style="max-height: calc(100vh - 200px); overflow-y: auto;"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  <div id="sideSequences" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="title">ä¿å­˜æ¸ˆ Sequences (ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ãƒ­ãƒ¼ãƒ‰)</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="seqList" class="list-container" style="max-height: calc(100vh - 200px); overflow-y: auto;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="exportSeq" class="small ghost">Export</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="importSeq" class="small ghost">Import</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="sideConfig" style="display:none; height:100%; display:flex; flex-direction:column;">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="blockConfigWrap" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title">Selected Block Configuration</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="blockConfig" class="config-container" style="max-height: 250px;">é¸æŠã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç·¨é›†ã§ãã¾ã™</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="title" style="margin-top:10px">Sequence Preview (JSON)</div>
Â  Â  Â  Â  Â  ã€€ã€€ã€€<pre id="seqPreview" style="max-height:100px; flex-shrink:0;">[]</pre>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="scratchLogContainer" style="flex-grow:1; display:flex; flex-direction:column;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title" style="margin-top:10px">Current Variables (Context)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <pre id="contextView" style="max-height:100px; min-height:50px; flex-shrink:0;">{}</pre>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="title">Sequence Log</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <pre id="scratchLog" style="flex-grow:1;">â€”</pre>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<footer>Local only â€” tokens, templates & sequences saved to localStorage</footer>

<div id="tokenModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
Â  Â  <div class="card" style="width:400px; height:auto; padding:20px;">
Â  Â  Â  Â  <div class="title">ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†</div>
Â  Â  Â  Â  <label>Label</label><input id="modalTokenLabel" type="text" placeholder="label" />
Â  Â  Â  Â  <label>Token</label><input id="modalTokenValue" type="password" placeholder="user token" />
Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  <button id="modalSaveToken" class="small ok">ä¿å­˜</button>
Â  Â  Â  Â  Â  Â  <button id="modalCloseToken" class="small ghost">é–‰ã˜ã‚‹</button>
Â  Â  Â  Â  Â  Â  <button id="clearTokens" class="small danger">å…¨éƒ¨å‰Šé™¤</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="muted" style="margin-top:15px">ä¿å­˜æ¸ˆãƒˆãƒ¼ã‚¯ãƒ³</div>
Â  Â  Â  Â  <div id="tokenList" class="list-container" style="max-height:200px;"></div>
Â  Â  </div>
</div>


<script>
const STORAGE_KEY = 'selfhub_rawapi_v2_light';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {tokens:{}, templates:{}, sequences:{}, icon:null}; }catch(e){ return {tokens:{}, templates:{}, sequences:{}, icon:null}; }}
function saveDB(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); }catch(e){} refreshTokenUI(); refreshTplUI(); refreshSeqList(); }
let DB = loadDB();
const $ = id => document.getElementById(id);
function logLineExec(s){ const el = $('execLog'); el.textContent = (el.textContent === 'â€”' ? '' : el.textContent) + '['+new Date().toLocaleTimeString()+'] ' + s + '\n'; el.scrollTop = el.scrollHeight; }
function logLineScratch(s){ const el = $('scratchLog'); el.textContent = (el.textContent === 'â€”' ? '' : el.textContent) + '['+new Date().toLocaleTimeString()+'] ' + s + '\n'; el.scrollTop = el.scrollHeight; }
function appendLog(s){
Â  Â  const isScratch = $('viewScratch').style.display !== 'none';
Â  Â  if (!isScratch) logLineExec(s);
Â  Â  if (isScratch) logLineScratch(s);
}
$('iconFile').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ DB.icon = r.result; saveDB(); $('iconPreview').src = DB.icon; appendLog('Icon saved'); }; r.readAsDataURL(f); });
$('removeIcon').onclick = ()=>{ DB.icon = null; saveDB(); $('iconPreview').src=''; };
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

function isJson(str) { try { JSON.parse(str); } catch (e) { return false; } return true; }

function injectVariables(input, context) {
Â  Â  if (typeof input !== 'string') return input;
Â  Â  const regex = /\{\{(\w+)\}\}/g;
Â  Â  return input.replace(regex, (match, varName) => {
Â  Â  Â  Â  const value = context[varName];
Â  Â  Â  Â  if (value === undefined || value === null) {
Â  Â  Â  Â  Â  Â  return match;
Â  Â  Â  Â  }
Â  Â  Â  Â  return String(value);
Â  Â  });
}

function extractValue(responseJson, path) {
Â  Â  if (!responseJson || !path) return undefined;
Â  Â  let parts = path.trim().replace(/^\./, '');
Â  Â 
Â  Â  if (parts.startsWith('[0]')) {
Â  Â  Â  Â  if (Array.isArray(responseJson) && responseJson.length > 0) {
Â  Â  Â  Â  Â  Â  responseJson = responseJson[0];
Â  Â  Â  Â  Â  Â  parts = parts.substring(3).replace(/^\./, '');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  return undefined;
Â  Â  Â  Â  }
Â  Â  } else if (parts.startsWith('[0].')) {
Â  Â  Â  Â  Â if (Array.isArray(responseJson) && responseJson.length > 0) {
Â  Â  Â  Â  Â  Â  responseJson = responseJson[0];
Â  Â  Â  Â  Â  Â  parts = parts.substring(4);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  return undefined;
Â  Â  Â  Â  }
Â  Â  }
Â  Â 
Â  Â  if (!parts) return responseJson;
Â  Â 
Â  Â  parts = parts.split('.');
Â  Â  let current = responseJson;

Â  Â  for (const part of parts) {
Â  Â  Â  Â  if (current === undefined || current === null) return undefined;
Â  Â  Â  Â  current = current[part];
Â  Â  }
Â  Â  return current;
}

async function fetchWithRetry(url, options, token) {
Â  Â  const maxRetries = 3;
Â  Â  const headers = options.headers || {};
Â  Â 
Â  Â  if (token) {
Â  Â  Â  Â  headers['Authorization'] = token;
Â  Â  }
Â  Â  headers['Content-Type'] = 'application/json';

Â  Â  for (let i = 0; i < maxRetries; i++) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(url, { ...options, headers: headers });
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  if (response.status === 429) {
Â  Â  Â  Â  Â  Â  Â  Â  const retryAfter = Number(response.headers.get('Retry-After')) || 1;
Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[API WARNING] 429 Rate Limit. Retrying in ${retryAfter} seconds...`);
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return response;
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  if (i < maxRetries - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[API ERROR] Network error. Retrying in 2 seconds... (${error.message})`);
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 2000));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`APIã‚³ãƒ¼ãƒ«å¤±æ•— (${url}): ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  Â  throw new Error('APIã‚³ãƒ¼ãƒ«ãŒæœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’è¶…éã—ã¾ã—ãŸã€‚');
}

function compareValues(a, b) {
Â  Â  let valA = a;
Â  Â  let valB = b;
Â  Â 
Â  Â  if (!isNaN(Number(valA)) && !isNaN(Number(valB))) {
Â  Â  Â  Â  valA = Number(valA);
Â  Â  Â  Â  valB = Number(valB);
Â  Â  }
Â  Â 
Â  Â  return valA === valB;
}

let runStopFlag = false;
window._scratch_context = {};
function refreshContextView() { $('contextView').textContent = JSON.stringify(window._scratch_context, null, 2); }

async function runSequence(sequence, token) {
Â  Â  const loopStack = [];
Â  Â  let i = 0;
Â  Â  window._scratch_context.status = undefined;

Â  Â  while (i < sequence.length) {
Â  Â  Â  Â  if (runStopFlag) {
Â  Â  Â  Â  Â  Â  appendLog('Sequence å®Ÿè¡Œã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚Šåœæ­¢ã—ã¾ã—ãŸã€‚');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const block = sequence[i];
Â  Â  Â  Â  const props = block.props || {};
Â  Â  Â  Â 
Â  Â  Â  Â  appendLog(`-> [${i + 1}/${sequence.length}] ${summaryForBlock(block)}`);

Â  Â  Â  Â  switch (block.type) {
Â  Â  Â  Â  Â  Â  case 'api':
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const url = 'https://discord.com/api/v9' + injectVariables(props.path, window._scratch_context);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const method = props.method || 'GET';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let bodyJson = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (props.body) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bodyStr = injectVariables(JSON.stringify(props.body), window._scratch_context);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isJson(bodyStr)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bodyJson = JSON.parse(bodyStr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Body JSON å±•é–‹å¾ŒãŒç„¡åŠ¹ã§ã™: ' + bodyStr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetchWithRetry(url, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: method,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: bodyJson ? JSON.stringify(bodyJson) : null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, token);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const jtxt = await res.text().catch(() => null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let j = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let logDetails = '';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  j = jtxt && jtxt.trim() ? JSON.parse(jtxt) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window._scratch_context.status = res.status;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (j) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logDetails = jtxt.length > 100 ? JSON.stringify(j).slice(0, 100) + '...' : jtxt;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (jtxt) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â logDetails = jtxt.length > 100 ? jtxt.slice(0, 100) + '...' : jtxt;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logDetails = '(No Content)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[API res] ${res.status} ${logDetails}`);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (props.extract && props.extract.var && props.extract.path && j) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const extracted = extractValue(j, props.extract.path);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (extracted !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window._scratch_context[props.extract.var] = extracted;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[EXTRACT OK] ${props.extract.var} = ${extracted}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[EXTRACT FAIL] Path ${props.extract.path} not found`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshContextView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[API CALL ERROR] ${e.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw e;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  case 'wait':
Â  Â  Â  Â  Â  Â  Â  Â  const delay = (Number(props.sec) || 1) * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`Waiting for ${props.sec} seconds...`);
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  case 'cond':
Â  Â  Â  Â  Â  Â  Â  Â  let conditionMet = false;
Â  Â  Â  Â  Â  Â  Â  Â  const targetVar = props.variable || 'status';
Â  Â  Â  Â  Â  Â  Â  Â  const requiredValue = props.value !== undefined ? props.value : 200;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  let actualValue;
Â  Â  Â  Â  Â  Â  Â  Â  if (targetVar === 'status') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actualValue = window._scratch_context.status;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const varKey = injectVariables(`{{${targetVar}}}`, window._scratch_context);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actualValue = varKey !== `{{${targetVar}}}` ? window._scratch_context[varKey] : window._scratch_context[targetVar];
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (actualValue !== undefined && compareValues(actualValue, requiredValue)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conditionMet = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[CONDITION OK] ${targetVar} (${actualValue}) == ${requiredValue}`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[CONDITION FAIL] ${targetVar} (${actualValue}) != ${requiredValue}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (conditionMet) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  case 'loop_start':
Â  Â  Â  Â  Â  Â  Â  Â  const count = Number(props.count) || 1;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (loopStack.length === 0 || loopStack[loopStack.length - 1].start !== i) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loopStack.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  start: i,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count: count,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  current: 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else if (loopStack[loopStack.length - 1].current >= count) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`Loop ${loopStack.length} Finished. Skipping to end...`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const startIndex = i;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let nestingLevel = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let foundEnd = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let j = i + 1; j < sequence.length; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sequence[j].type === 'loop_start') nestingLevel++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sequence[j].type === 'loop_end') nestingLevel--;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (nestingLevel === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  i = j + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loopStack.pop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  foundEnd = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!foundEnd) throw new Error('Loop Start ã«å¯¾å¿œã™ã‚‹ Loop End ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  case 'loop_end':
Â  Â  Â  Â  Â  Â  Â  Â  if (loopStack.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Loop End ãŒ Loop Start ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  const currentLoop = loopStack[loopStack.length - 1];
Â  Â  Â  Â  Â  Â  Â  Â  currentLoop.current++;

Â  Â  Â  Â  Â  Â  Â  Â  if (currentLoop.current < currentLoop.count) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  i = currentLoop.start;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`Loop ${currentLoop.current + 1}/${currentLoop.count} - Restarting...`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loopStack.pop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendLog('Loop Ended.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  case 'comment':
Â  Â  Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[WARNING] Unknown block type: ${block.type}`);
Â  Â  Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  }
Â  Â  }
}

$('tokenManagementBtn').onclick = () => $('tokenModal').style.display = 'flex';
$('modalCloseToken').onclick = () => $('tokenModal').style.display = 'none';

function refreshTokenUI(){
Â  Â  const list = $('tokenList'); list.innerHTML='';
Â  Â  const sel = $('selectToken'); sel.innerHTML='<option value="">--æœªé¸æŠ--</option>';
Â  Â  Object.entries(DB.tokens||{}).forEach(([id,t])=>{
Â  Â  Â  Â  const div = document.createElement('div'); div.className='item';
Â  Â  Â  Â  div.innerHTML = `<div><strong>${escapeHtml(t.label||id)}</strong><div class="small">â€¢â€¢â€¢â€¢${t.token?t.token.slice(-6):'(empty)'}</div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="useBtn small ok">é¸æŠ</button><button data-id="${id}" class="delBtn small danger">å‰Šé™¤</button></div>`;
Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  Â  const opt = document.createElement('option'); opt.value = id; opt.textContent = t.label||id; sel.appendChild(opt);
Â  Â  });
Â  Â  Array.from(document.getElementsByClassName('useBtn')).forEach(b=> b.onclick = ()=> {
Â  Â  Â  Â  $('selectToken').value = b.dataset.id;
Â  Â  Â  Â  $('tokenModal').style.display = 'none';
Â  Â  Â  Â  appendLog(`Token selected: ${DB.tokens[b.dataset.id].label}`);
Â  Â  });
Â  Â  Array.from(document.getElementsByClassName('delBtn')).forEach(b=> b.onclick = ()=> {
Â  Â  Â  Â  if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.tokens[b.dataset.id]; saveDB(); refreshTokenUI(); }
Â  Â  });
Â  Â  if (DB.icon) $('iconPreview').src = DB.icon;
}
$('modalSaveToken').onclick = ()=>{
Â  Â  const lbl = $('modalTokenLabel').value.trim();
Â  Â  const tok = $('modalTokenValue').value.trim();
Â  Â  if(!lbl||!tok){ alert('label ã¨ token ã‚’å…¥åŠ›'); return; }
Â  Â  const id = 't_'+Date.now(); DB.tokens = DB.tokens || {};
Â  Â  DB.tokens[id] = {label:lbl, token:tok}; saveDB(); refreshTokenUI();
Â  Â  $('modalTokenLabel').value=''; $('modalTokenValue').value='';
Â  Â  appendLog(`Token saved: ${lbl}`);
};
$('clearTokens').onclick = ()=>{ if(confirm('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ DB.tokens={}; saveDB(); refreshTokenUI(); } };

function refreshTplUI(){
Â  Â  const out = $('groupList'); out.innerHTML='';
Â  Â  Object.entries(DB.templates||{}).forEach(([id, t])=>{
Â  Â  Â  Â  const div = document.createElement('div'); div.className='item'; div.dataset.id = id;
Â  Â  Â  Â  div.onclick = () => loadTemplate(id);
Â  Â  Â  Â  const recipientCount = t.recipients ? t.recipients.split(',').filter(r => r.trim()).length : 0;
Â  Â  Â  Â  div.innerHTML = `<div><strong>${escapeHtml(t.name)}</strong><div class="small">${t.group_name||'No Name'} / Recipients: ${recipientCount}</div></div><div style="display:flex;gap:6px">${t.icon ? `<img src="${t.icon}" class="img-preview" />` : ''}<button data-id="${id}" class="delTplBtn small danger">å‰Šé™¤</button></div>`;
Â  Â  Â  Â  out.appendChild(div);
Â  Â  });
Â  Â  Array.from(document.getElementsByClassName('delTplBtn')).forEach(b=> b.onclick = (e)=> {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  if(confirm('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.templates[b.dataset.id]; saveDB(); refreshTplUI(); }
Â  Â  });

Â  Â  const sel = $('exec_template_select'); sel.innerHTML='<option value="">--ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ--</option>';
Â  Â  Object.entries(DB.templates||{}).forEach(([id, t])=>{
Â  Â  Â  Â  const opt = document.createElement('option'); opt.value = id; opt.textContent = t.name; sel.appendChild(opt);
Â  Â  });
}

$('saveTemplate').onclick = ()=>{
Â  Â  const name = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
Â  Â  if (!name) return;
Â  Â  const id = 'tpl_'+Date.now();
Â  Â  DB.templates[id] = {
Â  Â  Â  Â  name: name.trim(),
Â  Â  Â  Â  recipients: $('exec_recipients').value.trim(),
Â  Â  Â  Â  group_name: $('exec_name').value.trim(),
Â  Â  Â  Â  count: $('exec_count').value,
Â  Â  Â  Â  icon: DB.icon
Â  Â  };
Â  Â  saveDB();
Â  Â  appendLog(`Template saved: ${name}`);
}

$('exec_template_select').onchange = (e) => {
Â  Â  loadTemplate(e.target.value);
}

function loadTemplate(id) {
Â  Â  const tpl = DB.templates[id];
Â  Â  if (!tpl) {
Â  Â  Â  Â  $('exec_recipients').value = '';
Â  Â  Â  Â  $('exec_name').value = '';
Â  Â  Â  Â  $('exec_count').value = 1;
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  $('exec_recipients').value = tpl.recipients || '';
Â  Â  $('exec_name').value = tpl.group_name || '';
Â  Â  $('exec_count').value = tpl.count || 1;
Â  Â  if (tpl.icon) {
Â  Â  Â  Â  DB.icon = tpl.icon;
Â  Â  Â  Â  $('iconPreview').src = tpl.icon;
Â  Â  } else {
Â  Â  Â  Â  DB.icon = null;
Â  Â  Â  Â  $('iconPreview').src = '';
Â  Â  }
Â  Â  saveDB();
Â  Â  appendLog(`Template loaded: ${tpl.name}`);
}


// --- Sequence Management ---
function refreshSeqList(){
Â  Â  const out = $('seqList'); out.innerHTML='';
Â  Â  Object.entries(DB.sequences||{}).forEach(([id, s])=>{
Â  Â  Â  Â  const div = document.createElement('div'); div.className='item'; div.dataset.id = id;
Â  Â  Â  Â  div.onclick = () => loadSequence(id);
Â  Â  Â  Â  const blockCount = s.sequence ? s.sequence.length : 0;
Â  Â  Â  Â  div.innerHTML = `<div><strong>${escapeHtml(s.name)}</strong><div class="small">Blocks: ${blockCount}</div></div><div style="display:flex;gap:6px"><button data-id="${id}" class="delSeqBtn small danger">å‰Šé™¤</button></div>`;
Â  Â  Â  Â  out.appendChild(div);
Â  Â  });
Â  Â  Array.from(document.getElementsByClassName('delSeqBtn')).forEach(b=> b.onclick = (e)=> {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  if(confirm('Sequenceã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ delete DB.sequences[b.dataset.id]; saveDB(); refreshSeqList(); }
Â  Â  });
}

$('saveSeq').onclick = () => {
Â  Â  const name = $('seqName').value.trim();
Â  Â  if (!name) { alert('Sequenceåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
Â  Â  const sequence = getSequenceFromWorkspace();
Â  Â  if (sequence.length === 0) { alert('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
Â  Â 
Â  Â  const id = 'seq_'+Date.now();
Â  Â  DB.sequences[id] = { name: name, sequence: sequence };
Â  Â  saveDB();
Â  Â  appendLog(`Sequence saved: ${name}`);
}

function loadSequence(id) {
Â  Â  const seq = DB.sequences[id];
Â  Â  if (!seq || !seq.sequence) return;
Â  Â 
Â  Â  clearWorkspace();
Â  Â  $('seqName').value = seq.name;
Â  Â  seq.sequence.forEach(block => {
Â  Â  Â  Â  createWorkspaceBlock(block.type, block.props, block.id);
Â  Â  });
Â  Â  refreshSeqPreview();
Â  Â  appendLog(`Sequence loaded: ${seq.name}`);
}

// --- Tab Management ---
function showMainView(viewId) {
Â  Â  ['viewExec', 'viewScratch'].forEach(id => {
Â  Â  Â  Â  $(id).style.display = id === viewId ? 'block' : 'none';
Â  Â  });
Â  Â  ['tabExec', 'tabScratch'].forEach(id => {
Â  Â  Â  Â  $(id).classList.toggle('active', id === 'tab' + viewId.replace('view', ''));
Â  Â  });
Â  Â  if (viewId === 'viewScratch') {
Â  Â  Â  Â  refreshSeqPreview();
Â  Â  }
}
$('tabExec').onclick = () => showMainView('viewExec');
$('tabScratch').onclick = () => showMainView('viewScratch');

function showSideContent(contentId) {
Â  Â  ['sideTemplates', 'sideSequences', 'sideConfig'].forEach(id => {
Â  Â  Â  Â  $(id).style.display = id === contentId ? 'block' : 'none';
Â  Â  });
Â  Â  ['tabSideTemplates', 'tabSideSequences', 'tabSideConfig'].forEach(id => {
Â  Â  Â  Â  $(id).classList.toggle('active', id.replace('tabSide', 'side') === contentId);
Â  Â  });
Â  Â  if (contentId === 'sideConfig') {
Â  Â  Â  Â  refreshContextView();
Â  Â  Â  Â  refreshSeqPreview();
Â  Â  }
}
$('tabSideTemplates').onclick = () => showSideContent('sideTemplates');
$('tabSideSequences').onclick = () => showSideContent('sideSequences');
$('tabSideConfig').onclick = () => showSideContent('sideConfig');

// --- Workspace / Block Logic ---
function generateId(){ return 'block_' + Date.now() + Math.floor(Math.random() * 1000); }

function summaryForBlock(block){
Â  Â  const props = block.props || {};
Â  Â  switch(block.type){
Â  Â  Â  Â  case 'api':
Â  Â  Â  Â  Â  Â  return `${props.method||'GET'} ${props.path||'(no path)'} -> Save: ${props.extract ? props.extract.var : 'None'}`;
Â  Â  Â  Â  case 'wait':
Â  Â  Â  Â  Â  Â  return `Wait for ${props.sec||1} seconds`;
Â  Â  Â  Â  case 'loop_start':
Â  Â  Â  Â  Â  Â  return `LOOP Start (x${props.count||1})`;
Â  Â  Â  Â  case 'loop_end':
Â  Â  Â  Â  Â  Â  return `LOOP End`;
Â  Â  Â  Â  case 'cond':
Â  Â  Â  Â  Â  Â  return `IF ${props.variable||'status'} == ${props.value||200}`;
Â  Â  Â  Â  case 'comment':
Â  Â  Â  Â  Â  Â  return `Comment: ${props.text||'(empty)'}`;
Â  Â  Â  Â  default: return `Unknown Block (${block.type})`;
Â  Â  }
}

function updateBlockUI(blockEl, props, type){
Â  Â  blockEl.querySelector('.meta').textContent = type.toUpperCase();
Â  Â  blockEl.querySelector('.summary').textContent = summaryForBlock({type, props});
}

function createWorkspaceBlock(type, initialProps={}, id=generateId()){
Â  Â  const blockEl = document.createElement('div');
Â  Â  blockEl.className = 'wblock';
Â  Â  blockEl.dataset.id = id;
Â  Â  blockEl.dataset.type = type;
Â  Â  blockEl.draggable = true;
Â  Â  blockEl.props = initialProps;

Â  Â  blockEl.innerHTML = `
Â  Â  Â  Â  <div class="content">
Â  Â  Â  Â  Â  Â  <div class="meta"></div>
Â  Â  Â  Â  Â  Â  <div class="summary"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="btns">
Â  Â  Â  Â  Â  Â  <button class="editBtn small">âš™ï¸</button>
Â  Â  Â  Â  Â  Â  <button class="delBtn small danger">âŒ</button>
Â  Â  Â  Â  </div>
Â  Â  `;
Â  Â  updateBlockUI(blockEl, initialProps, type);

Â  Â  blockEl.querySelector('.delBtn').onclick = (e) => { e.stopPropagation(); blockEl.remove(); refreshSeqPreview(); };
Â  Â  blockEl.querySelector('.editBtn').onclick = (e) => { e.stopPropagation(); selectBlock(blockEl); };
Â  Â  blockEl.onclick = () => selectBlock(blockEl);

Â  Â  $('workspace').appendChild(blockEl);
Â  Â  refreshSeqPreview();
Â  Â  return blockEl;
}

function getSequenceFromWorkspace(){
Â  Â  return Array.from($('workspace').querySelectorAll('.wblock')).map(el => ({
Â  Â  Â  Â  id: el.dataset.id,
Â  Â  Â  Â  type: el.dataset.type,
Â  Â  Â  Â  props: el.props
Â  Â  }));
}

function refreshSeqPreview(){
Â  Â  const seq = getSequenceFromWorkspace();
Â  Â  $('seqPreview').textContent = JSON.stringify(seq, null, 2);
}

function clearWorkspace(){
Â  Â  $('workspace').innerHTML = '<div class="muted" style="text-align:center; padding-top:50px">ã“ã“ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>';
Â  Â  $('seqName').value = '';
Â  Â  $('blockConfigWrap').style.display = 'none';
Â  Â  Array.from($('workspace').querySelectorAll('.wblock')).forEach(el => el.classList.remove('selected'));
Â  Â  refreshSeqPreview();
}
$('clearWorkspace').onclick = clearWorkspace;

// --- Drag & Drop Handlers ---
Array.from(document.querySelectorAll('.palette .block')).forEach(el => {
Â  Â  el.addEventListener('dragstart', (e) => {
Â  Â  Â  Â  e.dataTransfer.setData('text/plain', el.dataset.type);
Â  Â  Â  Â  e.dataTransfer.effectAllowed = 'copy';
Â  Â  });
});

$('workspace').addEventListener('drop', (e) => {
Â  Â  e.preventDefault();
Â  Â  const type = e.dataTransfer.getData('text/plain');
Â  Â  if (type) {
Â  Â  Â  Â  if ($('workspace').querySelector('.muted')) {
Â  Â  Â  Â  Â  Â  $('workspace').innerHTML = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  createWorkspaceBlock(type);
Â  Â  Â  Â  refreshSeqPreview();
Â  Â  }
});

// --- Block Config Logic ---
let selectedBlock = null;

function selectBlock(blockEl){
Â  Â  if (selectedBlock) selectedBlock.classList.remove('selected');
Â  Â  selectedBlock = blockEl;
Â  Â  selectedBlock.classList.add('selected');
Â  Â  showSideContent('sideConfig');
Â  Â  renderBlockConfig(selectedBlock);
}

function renderBlockConfig(blockEl){
Â  Â  $('blockConfigWrap').style.display = 'block';
Â  Â  const cfg = $('blockConfig');
Â  Â  cfg.innerHTML = '';
Â  Â  const props = blockEl.props || {};

Â  Â  switch(blockEl.dataset.type){
Â  Â  Â  Â  case 'api':
Â  Â  Â  Â  Â  Â  cfg.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <label>Method</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="cfg_method"><option>GET</option><option>POST</option><option>PATCH</option><option>DELETE</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  <label>Path (e.g., /users/{{user_id}}/messages)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="cfg_path" type="text" placeholder="/channels/123/messages" />
Â  Â  Â  Â  Â  Â  Â  Â  <label>Body (JSON string or object)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="cfg_body"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="title" style="margin-top:15px">Extraction</div>
Â  Â  Â  Â  Â  Â  Â  Â  <label>Context Variable Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="cfg_extract_var" type="text" placeholder="e.g., last_id" />
Â  Â  Â  Â  Â  Â  Â  Â  <label>JSON Path (e.g., id or [0].channel_id)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="cfg_extract_path" type="text" placeholder="e.g., id" />
Â  Â  Â  Â  Â  Â  Â  Â  <button id="cfg_save" class="ok" style="margin-top:15px; width:100%">Save API Config</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  $('cfg_method').value = props.method || 'GET';
Â  Â  Â  Â  Â  Â  $('cfg_path').value = props.path || '';
Â  Â  Â  Â  Â  Â  $('cfg_body').value = props.body ? JSON.stringify(props.body, null, 2) : '';
Â  Â  Â  Â  Â  Â  $('cfg_extract_var').value = props.extract ? props.extract.var || '' : '';
Â  Â  Â  Â  Â  Â  $('cfg_extract_path').value = props.extract ? props.extract.path || '' : '';
Â  Â  Â  Â  Â  Â  $('cfg_save').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  let body = null;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bodyStr = $('cfg_body').value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (bodyStr) body = JSON.parse(bodyStr);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Body JSONãŒä¸æ­£ã§ã™ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  blockEl.props = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: $('cfg_method').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  path: $('cfg_path').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: body,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  extract: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var: $('cfg_extract_var').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  path: $('cfg_extract_path').value.trim()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  updateBlockUI(blockEl, blockEl.props, blockEl.dataset.type);
Â  Â  Â  Â  Â  Â  Â  Â  refreshSeqPreview();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'wait':
Â  Â  Â  Â  Â  Â  cfg.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <label>Delay (seconds)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="cfg_sec" type="number" min="0.1" step="0.1" />
Â  Â  Â  Â  Â  Â  Â  Â  <button id="cfg_save" class="ok" style="margin-top:15px; width:100%">Save Wait Config</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  $('cfg_sec').value = props.sec || 1;
Â  Â  Â  Â  Â  Â  $('cfg_save').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  blockEl.props = { sec: $('cfg_sec').value };
Â  Â  Â  Â  Â  Â  Â  Â  updateBlockUI(blockEl, blockEl.props, blockEl.dataset.type);
Â  Â  Â  Â  Â  Â  Â  Â  refreshSeqPreview();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'loop_start':
Â  Â  Â  Â  Â  Â  cfg.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <label>Loop Count</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="cfg_count" type="number" min="1" step="1" />
Â  Â  Â  Â  Â  Â  Â  Â  <button id="cfg_save" class="ok" style="margin-top:15px; width:100%">Save Loop Config</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  $('cfg_count').value = props.count || 1;
Â  Â  Â  Â  Â  Â  $('cfg_save').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  blockEl.props = { count: $('cfg_count').value };
Â  Â  Â  Â  Â  Â  Â  Â  updateBlockUI(blockEl, blockEl.props, blockEl.dataset.type);
Â  Â  Â  Â  Â  Â  Â  Â  refreshSeqPreview();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'cond':
Â  Â  Â  Â  Â  Â  cfg.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <label>Target Variable (e.g., status, last_id)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="cfg_variable" type="text" placeholder="status" />
Â  Â  Â  Â  Â  Â  Â  Â  <label>Required Value</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="cfg_value" type="text" placeholder="200" />
Â  Â  Â  Â  Â  Â  Â  Â  <button id="cfg_save" class="ok" style="margin-top:15px; width:100%">Save Condition</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  $('cfg_variable').value = props.variable || 'status';
Â  Â  Â  Â  Â  Â  $('cfg_value').value = props.value !== undefined ? props.value : 200;
Â  Â  Â  Â  Â  Â  $('cfg_save').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  blockEl.props = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  variable: $('cfg_variable').value.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value: $('cfg_value').value.trim()
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  updateBlockUI(blockEl, blockEl.props, blockEl.dataset.type);
Â  Â  Â  Â  Â  Â  Â  Â  refreshSeqPreview();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'comment':
Â  Â  Â  Â  Â  Â  cfg.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <label>Comment Text</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="cfg_text"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="cfg_save" class="ok" style="margin-top:15px; width:100%">Save Comment</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  $('cfg_text').value = props.text || '';
Â  Â  Â  Â  Â  Â  $('cfg_save').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  blockEl.props = { text: $('cfg_text').value.trim() };
Â  Â  Â  Â  Â  Â  Â  Â  updateBlockUI(blockEl, blockEl.props, blockEl.dataset.type);
Â  Â  Â  Â  Â  Â  Â  Â  refreshSeqPreview();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 'loop_end':
Â  Â  Â  Â  Â  Â  cfg.innerHTML = '<div class="muted">Loop Endãƒ–ãƒ­ãƒƒã‚¯ã«ã¯è¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
Â  Â  Â  Â  Â  Â  break;
Â  Â  }
}


// --- Execute View Logic ---
$('btnExec').onclick = async () => {
Â  Â  if (!window.confirm('ã“ã®è¨­å®šã§å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
Â  Â  $('execLog').textContent = 'â€”';
Â  Â 
Â  Â  const tokenEl = $('selectToken');
Â  Â  const tokenID = tokenEl.value;
Â  Â  if (!tokenID || !DB.tokens[tokenID]) { appendLog('[ERROR] ãƒˆãƒ¼ã‚¯ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
Â  Â 
Â  Â  if (!$('consentExec').checked) { appendLog('[ERROR] å®Ÿè¡Œãƒªã‚¹ã‚¯ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™ã€‚'); return; }

Â  Â  const token = DB.tokens[tokenID].token;
Â  Â  const count = Number($('exec_count').value) || 1;
Â  Â  const recipients = $('exec_recipients').value.trim().split(',').map(r => r.trim()).filter(r => r);
Â  Â  const name = $('exec_name').value.trim();
Â  Â  const icon = DB.icon;
Â  Â 
Â  Â  if (recipients.length === 0) { appendLog('[ERROR] RecipientsãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
Â  Â  if (recipients.length < 2) { appendLog('[ERROR] Group Creationã«ã¯2äººä»¥ä¸Šã®RecipientsãŒå¿…è¦ã§ã™ã€‚'); return; }

Â  Â  appendLog(`--- Group Creation Started (x${count}) ---`);
Â  Â 
Â  Â  for (let i = 0; i < count; i++) {
Â  Â  Â  Â  if (runStopFlag) { appendLog('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚Šå®Ÿè¡Œã‚’åœæ­¢ã—ã¾ã—ãŸã€‚'); break; }
Â  Â  Â  Â  appendLog(`[Attempt ${i + 1}/${count}] Creating group...`);
Â  Â  Â  Â 
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  recipient_ids: recipients,
Â  Â  Â  Â  Â  Â  name: name || undefined,
Â  Â  Â  Â  Â  Â  icon: icon || undefined
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const res = await fetchWithRetry('https://discord.com/api/v9/users/@me/channels', {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  }, token);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  const jtxt = await res.text().catch(() => 'no body');
Â  Â  Â  Â  Â  Â  const logDetails = jtxt.length > 100 ? jtxt.slice(0, 100) + '...' : jtxt;

Â  Â  Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[SUCCESS ${i + 1}] Status: ${res.status}. Response: ${logDetails}`);
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 500));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  appendLog(`[FAILURE ${i + 1}] Status: ${res.status}. Error: ${logDetails}`);
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 1000));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  appendLog(`[CRITICAL ERROR ${i + 1}] ${e.message}`);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  appendLog('--- Group Creation Finished ---');
}


// --- Sequence Run Logic ---
$('runSeq').onclick = async () => {
Â  Â  if (!window.confirm('Sequenceã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
Â  Â  $('scratchLog').textContent = 'â€”';
Â  Â  window._scratch_context = {};
Â  Â  refreshContextView();

Â  Â  const tokenEl = $('selectToken');
Â  Â  const tokenID = tokenEl.value;
Â  Â  if (!tokenID || !DB.tokens[tokenID]) { appendLog('[ERROR] ãƒˆãƒ¼ã‚¯ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
Â  Â  const token = DB.tokens[tokenID].token;

Â  Â  const sequence = getSequenceFromWorkspace();
Â  Â  if (sequence.length === 0) { appendLog('[ERROR] å®Ÿè¡Œã™ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }

Â  Â  runStopFlag = false;
Â  Â  $('btnStop').style.display = 'inline-block';
Â  Â  $('runSeq').disabled = true;

Â  Â  try {
Â  Â  Â  Â  appendLog('--- Sequence Execution Started ---');
Â  Â  Â  Â  await runSequence(sequence, token);
Â  Â  } catch (e) {
Â  Â  Â  Â  appendLog(`[CRITICAL ABORT] å®Ÿè¡Œä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
Â  Â  } finally {
Â  Â  Â  Â  runStopFlag = false;
Â  Â  Â  Â  $('btnStop').style.display = 'none';
Â  Â  Â  Â  $('runSeq').disabled = false;
Â  Â  Â  Â  appendLog('--- Sequence Execution Ended ---');
Â  Â  }
}

$('btnStop').onclick = () => {
Â  Â  runStopFlag = true;
}

// --- Init ---
document.addEventListener('DOMContentLoaded', () => {
Â  Â  refreshTokenUI();
Â  Â  refreshTplUI();
Â  Â  refreshSeqList();
Â  Â  showMainView('viewExec');
Â  Â  $('scratchLog').textContent = 'â€”';
Â  Â  $('execLog').textContent = 'â€”';
});

</script>
</body>
</html>
